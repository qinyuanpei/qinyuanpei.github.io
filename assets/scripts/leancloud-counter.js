function VisitorCounter(){this.config={appId:"",appKey:"",region:"",domain:"",site_uv:0,site_pv:0,collectIP:!0,collectUA:!0},this.init=function(e){var t=this,e=(t.mergeConfig(e),location.href),n=(n=e.split("//")[1]).substring(0,n.indexOf("/")),i=document.title,e={page_url:n};this.queryClass("VisitorCounter",e).then(function(e){0==e.results.length&&((e={}).page_pv=site_pv,e.page_uv=site_uv,e.page_url=n,e.page_title=i,t.createClass("VisitorCounter",e).then(function(e){console.log("init PV/UV of "+n+"success")}))}),this.injectScript(),this.pagePV(),this.pageUV(),this.sitePV(),this.siteUV()},this.sitePV=function(){var e=location.href,e={page_url:e=-1!=e.indexOf("//")?(e=e.split("//")[1]).substring(0,e.indexOf("/")):e};this.queryClass("VisitorCounter",e).then(function(e){var t;0<e.results.length&&(e=e.results[0],null!=(t=document.getElementById("lc_counter_value_site_pv"))&&(t.innerText=e.page_pv))})},this.siteUV=function(){var e=location.href,e={page_url:e=-1!=e.indexOf("//")?(e=e.split("//")[1]).substring(0,e.indexOf("/")):e};this.queryClass("VisitorCounter",e).then(function(e){var t;0<e.results.length&&(e=e.results[0],console.log(e),null!=(t=document.getElementById("lc_counter_value_site_uv"))&&(t.innerText=e.page_uv))})},this.pagePV=function(){var n=location.href.replace(location.search,""),i=document.title,r=this;this.queryClass("VisitorCounter",{page_url:n}).then(function(e){var t;0<e.results.length?(e=e.results[0],(t={}).objectId=e.objectId,t.page_pv=e.page_pv,t.page_pv+=1,r.updateClass("VisitorCounter",t).then(function(e){console.log(e)})):((t={}).page_title=i,t.page_url=n,t.page_pv=1,t.page_uv=1,r.createClass("VisitorCounter",t)),null!=(e=document.getElementById("lc_counter_value_page_pv"))&&(e.innerText=t.page_pv)})},this.pageUV=function(){var t=location.href.replace(location.search,""),n=document.title,e=JSON.parse(localStorage.getItem("ipInfo")),e={page_url:t,visitor_ip:e.ip},i=this;i.queryClass("VisitorRecord",e).then(function(e){0==e.results.length&&((newRecord={}).page_url=t,newRecord.page_title=n,e=JSON.parse(localStorage.getItem("ipInfo")),newRecord.visitor_ip=e.ip,newRecord.visitor_geo=e,e=new UAParser,newRecord.visitor_ua=e.getResult(),console.log(newRecord.visitor_ua),i.createClass("VisitorRecord",newRecord))}).then(function(e){console.log(e)}),i.queryClass("VisitorCounter",{page_url:t}).then(function(e){var t;0<e.results.length&&(e=e.results[0],console.log(e),null!=(t=document.getElementById("lc_counter_value_page_uv"))&&(t.innerText=e.page_uv))})},this.queryClass=function(e,t){var n=this.buildHeaders(),e=this.config.baseUrl+"/1.1/classes/"+e+"?where="+JSON.stringify(t);return fetch(e,{mode:"cors",method:"GET",headers:n}).then(function(e){return e.json()})},this.createClass=function(e,t){var n=this.buildHeaders(),e=this.config.baseUrl+"/1.1/classes/"+e;return fetch(e,{mode:"cors",method:"POST",headers:n,body:JSON.stringify(t)}).then(function(e){return e.json()})},this.updateClass=function(e,t){var n=this.buildHeaders(),e=this.config.baseUrl+"/1.1/classes/"+e+"/"+t.objectId;return fetch(e,{mode:"cors",method:"PUT",headers:n,body:JSON.stringify(t)}).then(function(e){return e.json()})},this.injectScript=function(){var e=document.getElementsByTagName("head")[0];for(script of["https://api.ip.sb/geoip?callback=handleIP","https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/scripts/ua-parser.min.js"]){var t=document.createElement("script");t.type="text/javascript",t.src=script,e.appendChild(t)}window.handleIP=function(e){this.localStorage.clear(),this.localStorage.setItem("ipInfo",this.JSON.stringify(e))}},this.mergeConfig=function(e){for(key in e=e||{})void 0!==e[key]&&(this.config[key]=e[key]);if(""==this.config.appId||""==this.config.appKey)throw"请输入当前应用的AppId和AppKey";if(""!=this.config.domain)this.config.baseUrl=this.config.domain;else{if(""!=this.config.region)switch(this.config.region){case"华东":case"华北":case"国际":this.config.baseUrl="https://"+this.config.appId.substring(0,8)+".api.lncld.net"}this.config.baseUrl="https://"+this.config.appId.substring(0,8)+".api.lncld.net"}},this.buildHeaders=function(){var e=(new Date).getTime(),t=(new Utils).md5(e+this.config.appKey);return{"X-LC-Id":this.config.appId,"X-LC-Sign":t+","+e,"Content-Type":"application/json"}}}function Utils(){this.md5=function(e){function a(e,t){return e<<t|e>>>32-t}var t,n,i,r,s,o,c,l,u,g,h=function(e,t){var n=2147483648&e,i=2147483648&t,r=1073741824&e,s=1073741824&t,e=(1073741823&e)+(1073741823&t);return r&s?2147483648^e^n^i:r|s?1073741824&e?3221225472^e^n^i:1073741824^e^n^i:e^n^i},p=function(e,t,n,i,r,s,o){return e=h(e,h(h(t&n|~t&i,r),o)),h(a(e,s),t)},f=function(e,t,n,i,r,s,o){return e=h(e,h(h(t&i|n&~i,r),o)),h(a(e,s),t)},d=function(e,t,n,i,r,s,o){return e=h(e,h(h(t^n^i,r),o)),h(a(e,s),t)},v=function(e,t,n,i,r,s,o){return e=h(e,h(h(n^(t|~i),r),o)),h(a(e,s),t)},_=function(e){for(var t,n=e.length,i=n+8,i=16*(1+(i-i%64)/64),r=Array(i-1),s=0,o=0;o<n;)s=o%4*8,r[t=(o-o%4)/4]=r[t]|e.charCodeAt(o)<<s,o++;return r[t=(o-o%4)/4]=r[t]|128<<(s=o%4*8),r[i-2]=n<<3,r[i-1]=n>>>29,r},C=function(e){for(var t="",n="",i=0;i<=3;i++)t+=(n="0"+(e>>>8*i&255).toString(16)).substr(n.length-2,2);return t},m=function(e){e=e.toString().replace(/\x0d\x0a/g,"\n");for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):t=127<i&&i<2048?(t+=String.fromCharCode(i>>6|192))+String.fromCharCode(63&i|128):(t=(t+=String.fromCharCode(i>>12|224))+String.fromCharCode(i>>6&63|128))+String.fromCharCode(63&i|128)}return t};for(Array(),e=m(e),t=_(e),c=1732584193,l=4023233417,u=2562383102,g=271733878,n=0;n<t.length;n+=16)c=p(i=c,r=l,s=u,o=g,t[n+0],7,3614090360),g=p(g,c,l,u,t[n+1],12,3905402710),u=p(u,g,c,l,t[n+2],17,606105819),l=p(l,u,g,c,t[n+3],22,3250441966),c=p(c,l,u,g,t[n+4],7,4118548399),g=p(g,c,l,u,t[n+5],12,1200080426),u=p(u,g,c,l,t[n+6],17,2821735955),l=p(l,u,g,c,t[n+7],22,4249261313),c=p(c,l,u,g,t[n+8],7,1770035416),g=p(g,c,l,u,t[n+9],12,2336552879),u=p(u,g,c,l,t[n+10],17,4294925233),l=p(l,u,g,c,t[n+11],22,2304563134),c=p(c,l,u,g,t[n+12],7,1804603682),g=p(g,c,l,u,t[n+13],12,4254626195),u=p(u,g,c,l,t[n+14],17,2792965006),l=p(l,u,g,c,t[n+15],22,1236535329),c=f(c,l,u,g,t[n+1],5,4129170786),g=f(g,c,l,u,t[n+6],9,3225465664),u=f(u,g,c,l,t[n+11],14,643717713),l=f(l,u,g,c,t[n+0],20,3921069994),c=f(c,l,u,g,t[n+5],5,3593408605),g=f(g,c,l,u,t[n+10],9,38016083),u=f(u,g,c,l,t[n+15],14,3634488961),l=f(l,u,g,c,t[n+4],20,3889429448),c=f(c,l,u,g,t[n+9],5,568446438),g=f(g,c,l,u,t[n+14],9,3275163606),u=f(u,g,c,l,t[n+3],14,4107603335),l=f(l,u,g,c,t[n+8],20,1163531501),c=f(c,l,u,g,t[n+13],5,2850285829),g=f(g,c,l,u,t[n+2],9,4243563512),u=f(u,g,c,l,t[n+7],14,1735328473),l=f(l,u,g,c,t[n+12],20,2368359562),c=d(c,l,u,g,t[n+5],4,4294588738),g=d(g,c,l,u,t[n+8],11,2272392833),u=d(u,g,c,l,t[n+11],16,1839030562),l=d(l,u,g,c,t[n+14],23,4259657740),c=d(c,l,u,g,t[n+1],4,2763975236),g=d(g,c,l,u,t[n+4],11,1272893353),u=d(u,g,c,l,t[n+7],16,4139469664),l=d(l,u,g,c,t[n+10],23,3200236656),c=d(c,l,u,g,t[n+13],4,681279174),g=d(g,c,l,u,t[n+0],11,3936430074),u=d(u,g,c,l,t[n+3],16,3572445317),l=d(l,u,g,c,t[n+6],23,76029189),c=d(c,l,u,g,t[n+9],4,3654602809),g=d(g,c,l,u,t[n+12],11,3873151461),u=d(u,g,c,l,t[n+15],16,530742520),l=d(l,u,g,c,t[n+2],23,3299628645),c=v(c,l,u,g,t[n+0],6,4096336452),g=v(g,c,l,u,t[n+7],10,1126891415),u=v(u,g,c,l,t[n+14],15,2878612391),l=v(l,u,g,c,t[n+5],21,4237533241),c=v(c,l,u,g,t[n+12],6,1700485571),g=v(g,c,l,u,t[n+3],10,2399980690),u=v(u,g,c,l,t[n+10],15,4293915773),l=v(l,u,g,c,t[n+1],21,2240044497),c=v(c,l,u,g,t[n+8],6,1873313359),g=v(g,c,l,u,t[n+15],10,4264355552),u=v(u,g,c,l,t[n+6],15,2734768916),l=v(l,u,g,c,t[n+13],21,1309151649),c=v(c,l,u,g,t[n+4],6,4149444226),g=v(g,c,l,u,t[n+11],10,3174756917),u=v(u,g,c,l,t[n+2],15,718787259),l=v(l,u,g,c,t[n+9],21,3951481745),c=h(c,i),l=h(l,r),u=h(u,s),g=h(g,o);return(C(c)+C(l)+C(u)+C(g)).toLowerCase()}}