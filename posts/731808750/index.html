<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="pragma" content="no-cache"><meta http-equiv="cache-control" content="no-cache"><meta name="msvalidate.01" content="713A48A3FE17D4841C292A6B3942EB4C"><title>ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT) | 一个人的孤落时辰</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#3F51B5"><meta name="keywords" content="微服务,Envoy,JWT,Keycloak,认证,秦元培,技术博客,生活随笔,个人博客,NET,Python,数据挖掘,数据分析,NLP"><meta name="description" content="可以注意到，我们这里配置了一个叫做`envoy.filters.http.jwt_authn`的过滤器，并为这个过滤器指定了一个叫做`jwt_provider`的认证提供者，其中的`issuer`和`audiences`，我们在讲解 JWT 结构的时候提到过，最为关键的是`remote_jwks`，我们通过 Keycloak 的服务发现功能，可以获得这个地址，我们将其配置到 Envoy 中即可，Envoy 可以通过它来验证一个 JWT 的令牌，而下面的规则，表示哪些路由需要认证，这里我们假设需要对`/api/w`和`/api/c`这两个端点进行认证;可以注意到，图中有我们需要的换取令牌的接口，以及提供 JWKS 的接口：`/auth/realms/master/protocol/openid-connect/certs&#34;`，尤其第二点，它对于对我们进行下一个步骤意义重大，Envoy 能不能承担起微服务认证的重担，就看它的啦，至此， Keycloak 的搭建工作已经完成;因为 Keycloak 这个认证中心是独立于我们的应用单独存在的，所以，我们可以直接在 Keycloak 中设置令牌的过期时间、为用户分配角色、为不同的资源设置范围等等，而这一切都不需要应用程序或者 Envoy 做任何调整，开发者只需要认真地写好每一个后端服务即可，这是否就是传说中的基础设施即服务呢;通过 JWKS 的 [官网](https://auth0.com/docs/tokens/json-web-tokens/json-web-key-sets)，我们可以了解到一件事情，那就是 JWKS 本质上是 Json Web Key Set 的简称，顾名思义，这是一组可以校验任意 JWT 的公钥，并且这些 JWT 必须是通过 RS256 算法进行签名的，RS256 则是我们上面这张图里的 RSA 非对唱加密算法，它需要一个公钥和一个私钥，通常强况下，私钥用来生成签名，公钥用来校验签名;其中，JWT 即JSON Web Token，是目前最为流行的跨域认证方案，一个 JWT 通常由 `header`、`payload` 和 `signature` 三个部分组成，JWT 的 JSON 主要体现在`header`和`payload`这两个 JSON 对象上，通过 Base64Url 算法实现串化，而 `signature` 部分则是由`header`和`payload`按照签名函数进行生成，主要目的是防止数据篡改"><meta name="description" content="可以注意到，我们这里配置了一个叫做&#96;envoy.filters.http.jwt_authn&#96;的过滤器，并为这个过滤器指定了一个叫做&#96;jwt_provider&#96;的认证提供者，其中的&#96;issuer&#96;和&#96;audiences&#96;，我们在讲解 JWT 结构的时候提到过，最为关键的是&#96;remote_jwks&#96;，我们通过 Keycloak 的服务发现功能，可以获得这个地址，我们将其配置到 Envoy 中即可，E"><meta property="og:type" content="article"><meta property="og:title" content="ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)"><meta property="og:url" content="https://qinyuanpei.github.io/posts/731808750/index.html"><meta property="og:site_name" content="一个人的孤落时辰"><meta property="og:description" content="可以注意到，我们这里配置了一个叫做&#96;envoy.filters.http.jwt_authn&#96;的过滤器，并为这个过滤器指定了一个叫做&#96;jwt_provider&#96;的认证提供者，其中的&#96;issuer&#96;和&#96;audiences&#96;，我们在讲解 JWT 结构的时候提到过，最为关键的是&#96;remote_jwks&#96;，我们通过 Keycloak 的服务发现功能，可以获得这个地址，我们将其配置到 Envoy 中即可，E"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2021/07/23/U9Pm3HFLn1y6dYB.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/H8xy3BYDz1XmWf9.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/ZDui9X3weq5NMs8.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/MJC3dVkE7UxopyO.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/le5rstobVOh91m3.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/S5rgmZaGEqQkHUK.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/ukdNami5yMERWDc.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/bDYNASUw23qLyml.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/Tdag82VsSGJxD9u.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/zDx765FpRMaP8mK.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/mpVo8vasYWL4gPN.png"><meta property="og:image" content="https://i.loli.net/2021/07/23/N6ybGazKBUSfE2H.png"><meta property="og:image" content="https://i.loli.net/2021/07/24/lQrXThYCvk9RPLm.png"><meta property="og:image" content="https://i.loli.net/2021/07/24/Bg5r8dAIbEp4eFy.png"><meta property="og:image" content="https://i.loli.net/2021/07/24/rCcUBWDyJVtOxkd.png"><meta property="article:published_time" content="2021-07-25T09:41:24.000Z"><meta property="article:modified_time" content="2021-09-22T08:56:43.949Z"><meta property="article:author" content="飞鸿踏雪"><meta property="article:tag" content="微服务"><meta property="article:tag" content="Envoy"><meta property="article:tag" content="JWT"><meta property="article:tag" content="Keycloak"><meta property="article:tag" content="认证"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2021/07/23/U9Pm3HFLn1y6dYB.png"><link rel="alternate" type="application/atom+xml" title="一个人的孤落时辰" href="/atom.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/images/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master//assets/styles/style.css"><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/instantclick.min.js"></script><script>window.lazyScripts=[]</script><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading" class="active"></div><aside id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap" style="background-image:url(https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/images/brand.jpg)"><div class="brand"><a href="/" class="avatar waves-effect waves-circle waves-light"><img src="https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/images/avatar.jpg" alt="avatar"></a><hgroup class="introduce"><h5 class="nickname">飞鸿踏雪</h5><a href="mailto:qinyuanpei@163.com" title="qinyuanpei@163.com" class="mail">qinyuanpei@163.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="icon icon-lg icon-home"></i> 主页</a></li><li class="waves-block waves-effect"><a href="/archives"><i class="icon icon-lg icon-archives"></i> 归档</a></li><li class="waves-block waves-effect"><a href="/tags"><i class="icon icon-lg icon-tags"></i> 标签</a></li><li class="waves-block waves-effect"><a href="/categories"><i class="icon icon-lg icon-th-list"></i> 分类</a></li><li class="waves-block waves-effect"><a href="/books"><i class="icon icon-lg icon-bookmark"></i> 书单</a></li><li class="waves-block waves-effect"><a href="/movies"><i class="icon icon-lg icon-film"></i> 影单</a></li><li class="waves-block waves-effect"><a href="https://qinyuanpei.github.io/poems/"><i class="icon icon-lg icon-folder-open"></i> 诗集</a></li><li class="waves-block waves-effect"><a href="/works"><i class="icon icon-lg icon-code"></i> 实验室</a></li><li class="waves-block waves-effect"><a href="/about"><i class="icon icon-lg icon-circle"></i> 关于我</a></li></ul></div></div></aside><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"> <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare"><i class="icon icon-lg icon-share-alt"></i> </a><a href="https://github.com/qinyuanpei/qinyuanpei.github.io" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="menuGithub"><i class="icon icon-lg icon-code-fork"></i></a></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)</h1><h5 class="subtitle" id="subtitle"><time datetime="2021-07-25T09:41:24.000Z" itemprop="datePublished" class="page-time">2021-07-25</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li></ul></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap" id="post-toc"><h4>目录</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#搭建-Keycloak"><span class="post-toc-number">1.</span> <span class="post-toc-text">搭建 Keycloak</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#配置-Envoy"><span class="post-toc-number">2.</span> <span class="post-toc-text">配置 Envoy</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#编写-API"><span class="post-toc-number">3.</span> <span class="post-toc-text">编写 API</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#服务编排"><span class="post-toc-number">4.</span> <span class="post-toc-text">服务编排</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#本文小结"><span class="post-toc-number">5.</span> <span class="post-toc-text">本文小结</span></a></li></ol></nav></aside><article id="post-ASP-NET-Core-搭载-Envoy-实现微服务身份认证(JWT)" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)</h1><div class="post-meta"><time class="post-time" title="2021-07-25 09:41:24" datetime="2021-07-25T09:41:24.000Z" itemprop="datePublished">2021-07-25</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li></ul><span id="lc_counter_container_page_pv" title="文章总阅读量" data-page-url="" data-page-title="ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)"><i class="icon icon-eye icon-pr"></i><span id="lc_counter_value_page_pv"></span></span> <span><i class="icon icon-clock-o"></i> 33 min.</span></div><div class="post-content" id="post-content" itemprop="postContent"><p>在构建以 gRPC 为核心的微服务架构的过程中，得益于 Envoy 对 gRPC 的“<strong>一等公民</strong>”支持，我们可以在过滤器中对 gRPC 服务进行转码，进而可以像调用 Web API 一样去调用一个 gRPC 服务。通常情况下， RPC 会作为微服务间内部通信的信使，例如，Dubbo、Thrift、gRPC、WCF 等等更多是应用在对内通信上。所以，一旦我们通过 Envoy 将这些 gRPC 服务暴露出来，其性质就会从对内通信变为对外通信。我们知道，对内和对外的接口，无论是安全性还是规范性，都有着相当大的区别。博主从前的公司，对内的 WCF 接口，长年处于一种”<strong>裸奔</strong>“的状态，属于没有授权、没有认证、没有文档的“<strong>三无产品</strong>”。那么，当一个 gRPC 服务通过 Envoy 暴露出来以后，我们如何保证接口的安全性呢？这就是今天这篇博客的主题，即 Envoy 作为网关如何提供身份认证功能，在这里，我们特指通过JWT，即 Json Web Token 来对接口调用方进行身份认证。</p><h1 id="搭建-Keycloak"><a href="#搭建-Keycloak" class="headerlink" title="搭建 Keycloak"></a>搭建 Keycloak</h1><p>对于 <a href="https://jwt.io" target="_blank" rel="noopener">JWT</a> ，即 Json Web Token ，我想大家应该都非常熟悉了，它是目前最流行的跨域认证解决方案。考虑到，传统的 Session 机制，在面对集群环境时，扩展性方面表现不佳。在日益服务化、集群化的今天，这种无状态的、轻量级的认证方案，自然越来越受到人们的青睐。在 ASP.NET Core 中整合JWT非常简单，因为有各种第三方库可以帮助你生成令牌，你唯一需要做的就是配置授权/认证中间件，它可以帮你完成令牌校验这个环节的工作。除此以外，你还可以选择更重量级的 <a href="https://identityserver4.readthedocs.io/en/latest/" target="_blank" rel="noopener">Identity Server 4</a>，它提供了更加完整的身份认证解决方案。在今天这篇博客里，我们使用的 <a href="https://www.keycloak.org" target="_blank" rel="noopener">Keycloak</a>，一个类似 Identity Server 4 的产品，它提供了一个更加友好的用户界面，可以更加方便的管理诸如客户端、用户、角色等等信息。其实，如果从头开始写不是不可以，可惜博主一时间无法实现 <a href="https://auth0.com/docs/tokens/json-web-tokens/json-web-key-sets" target="_blank" rel="noopener">JWKS</a>，所以，就请大家原谅在下拾人牙慧，关于 JWKS ，我们会在下一节进行揭晓。接触微服务以来，在做技术选型时，博主的一个关注点是，这个方案是否支持容器化。所以，在这一点上，显然是 Keycloak 略胜一筹，为了安装 Ketcloak ，我们准备了如下的服务编排文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">keycloak:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/keycloak/keycloak:14.0.0</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEYCLOAK_USER:</span> <span class="string">$&#123;KEYCLOAK_USER&#125;</span></span><br><span class="line">      <span class="attr">KEYCLOAK_PASSWORD:</span> <span class="string">$&#123;KEYCLOAK_PASS&#125;</span></span><br><span class="line">      <span class="attr">DB_VENDOR:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">DB_ADDR:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">DB_DATABASE:</span> <span class="string">$&#123;POSTGRESQL_DB&#125;</span></span><br><span class="line">      <span class="attr">DB_USER:</span> <span class="string">$&#123;POSTGRESQL_USER&#125;</span></span><br><span class="line">      <span class="attr">DB_PASSWORD:</span> <span class="string">$&#123;POSTGRESQL_PASS&#125;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"7070:8080"</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13.2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">$&#123;POSTGRESQL_DB&#125;</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">$&#123;POSTGRESQL_USER&#125;</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">$&#123;POSTGRESQL_PASS&#125;</span></span><br></pre></td></tr></table></figure><p>其中，<code>.env</code>文件放置了服务编排文件中使用到的环境变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># KEYCLOAK</span><br><span class="line">KEYCLOAK_USER&#x3D;admin</span><br><span class="line">KEYCLOAK_PASS&#x3D;admin</span><br><span class="line"># POSTGRESQL</span><br><span class="line">POSTGRESQL_DB&#x3D;keycloak</span><br><span class="line">POSTGRESQL_USER&#x3D;keycloak</span><br><span class="line">POSTGRESQL_PASS&#x3D;keycloak</span><br></pre></td></tr></table></figure><p>此时，我们运行<code>docker compose up</code>命令就可以得到一个 Keycloak 环境，它将作为我们整个微服务里的认证中心，负责对用户、角色、权限、客户端等进行管理。于此同时，接口消费方可以通过 Keycloak 获取令牌、JWKS，而 Envoy 正是利用 JWKS 来对令牌进行校验的。这个 JWKS 到底是何方神圣，我们暂且按下不表。在正式使用 Keycloak 前，我们需要做一点简单的配置工作，具体来说，就是指创建用户、角色和客户端，我们一起来看一下。</p><p>首先，是创建一个用户，这里以《天龙八部》中壮志未酬的“<strong>慕容龙城</strong>”为例：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/U9Pm3HFLn1y6dYB.png" alt="Keycloak 创建用户" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 创建用户</div></figure><p>《天龙八部》中提到，“<strong>慕容龙城</strong>”一心想光复大燕，可惜时不我与，正好遇上宋太祖建立宋朝，即使他创造出“<strong>斗转星移</strong>”的武功绝学，依然免不了郁郁而终的结局。慕容龙城算是第一代创业者，我们准备一个<code>Developer</code>的角色：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/H8xy3BYDz1XmWf9.png" alt="Keycloak 创建角色" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 创建角色</div></figure><p>在权限系统的设计中，角色总是需要和用户关联在一起。同样地，在 Keycloak 中，我们需要给“<strong>慕容龙城</strong>”分配一个<code>Developer</code>的角色：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/ZDui9X3weq5NMs8.png" alt="Keycloak 分配角色" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 分配角色</div></figure><p>到了“<strong>慕容复</strong>”这一代，“<strong>慕容垂</strong>”假借死亡之名秘密活动，而活跃在台前的“<strong>慕容复</strong>”，实际上是作为慕容家族的“<strong>代理人</strong>”出现。在今天这篇文章中，Envoy 会充当认证服务的代理，因为我们希望 Envoy 可以对所有进站的 API 请求进行统一的认证。所以，这里，我们还需要创建一个客户端：<code>envoy-client</code>，并为其分配客户端角色：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/MJC3dVkE7UxopyO.png" alt="Keycloak 创建客户端" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 创建客户端</div></figure><p>OK，我们都知道，<a href="https://oauth.net/2/" target="_blank" rel="noopener">OAuth 2.0</a> 有这样四种认证方式：密码模式、客户端模式、简化模式、授权码模式。这四种认证方式如何在 Keycloak 中实现呢？目前，博主基本搞清楚了前面两种。我们在创建完客户端以后，可以通过设置访问类型来决定客户端使用哪种认证方式，目前已知，当访问类型的取值为<code>public</code>时，表示密码模式。当访问类型的取值为<code>confidential</code>时，表示客户端模式。这里，我们以客户端模式为例：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/le5rstobVOh91m3.png" alt="Keycloak 客户端模式" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 客户端模式</div></figure><p>此时，我们就可以拿到一个重要的信息：<code>client_secret</code>，如果大家使用过客户端模式，就会知道它是获取令牌的重要参数之一。好了，当我们有了这些信息以后，该怎么样去获取令牌呢？我们只需要用 POST 的方式，将<code>grant_type</code>、<code>client_id</code>、<code>client_secret</code>、<code>username</code>、<code>password</code>、<code>scope</code>传过去即可：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/S5rgmZaGEqQkHUK.png" alt="从 Keycloak 获取令牌" referrerpolicy="no-referrer"></div><div class="image-caption">从 Keycloak 获取令牌</div></figure><p>如果需要刷新令牌，则只需要再追加一个<code>refresh_token</code>参数即可，它是我们第一次获取到的令牌：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/ukdNami5yMERWDc.png" alt="从 Keycloak 刷新令牌" referrerpolicy="no-referrer"></div><div class="image-caption">从 Keycloak 刷新令牌</div></figure><p>可能大家会疑惑，博主是从哪里知道这些 API 的端点地址的呢？其实，和 Identity Server 4 类似， Keycloak 提供了一个用于服务发现的接口地址：<code>/auth/realms/master/.well-known/openid-configuration</code>，通过这个接口地址，我们可以获得一份 API 列表：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/bDYNASUw23qLyml.png" alt="Keycloak 提供的 “服务发现” 能力" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 提供的 “服务发现” 能力</div></figure><p>可以注意到，图中有我们需要的换取令牌的接口，以及提供 JWKS 的接口：<code>/auth/realms/master/protocol/openid-connect/certs&quot;</code>，尤其第二点，它对于对我们进行下一个步骤意义重大，Envoy 能不能承担起微服务认证的重担，就看它的啦，至此， Keycloak 的搭建工作已经完成。</p><h1 id="配置-Envoy"><a href="#配置-Envoy" class="headerlink" title="配置 Envoy"></a>配置 Envoy</h1><p>在上一节内容中，博主卖了一个关子，说要等到这一节再说 JWKS 是何方神圣？不过，博主以为，“<strong>饭要一口一口吃，步子迈太大，咔，容易扯着蛋</strong>”，我们还是先来说说 JWT ，因为只要你了解了它的结构，你才能了解如何去检验一个令牌。我们说，JWT，是 JSON Web Token 的简称，那这个 JSON 到底体现在哪里呢？而这要从 JWT 的结构开始说起。</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/Tdag82VsSGJxD9u.png" alt="JSON Web Token 结构说明图" referrerpolicy="no-referrer"></div><div class="image-caption">JSON Web Token 结构说明图</div></figure><p>这是一张来自 <a href="https://jwt.io/" target="_blank" rel="noopener">JWT</a> 官网的截图，博主认为，这张图非常清晰地展示出了 JWT 的加密过程，我们熟悉的这个令牌，其实是由<code>header</code>、<code>payload</code>和<code>signature</code>三个部分组成，其基本格式为：<code>header.payload.signature</code>，细心的朋友会发现，图中生成的令牌中含有两个<code>.</code>。其中，<code>header</code>部分是一个 JSON 对象，表示类型(<strong>typ</strong>)及加密算法(<strong>alg</strong>)，常见的加密算法主要有 HMAC、RSA、ECDSA 三个系列。<code>payload</code>部分同样是一个 JSON 对象，主要用来存放实际需要传递的数据。目前，JWT 官方规定了以下7个备选字段：</p><ul><li>iss，即 issuer，表示：令牌签发人</li><li>exp，即 expiration time，表示：令牌过期时间</li><li>sub，即 subject，表示：令牌主题</li><li>aud，即 audience，表示：令牌受众</li><li>nbf，即 Not Before，表示：令牌生效时间</li><li>iat，即 Issued At，表示：令牌签发时间</li><li>jti，即 JWT ID，表示：令牌编号</li></ul><p>需要注意的是，<code>header</code>和<code>payload</code>这两部分，默认是不加密的，这意味着任何人都可以读到这里的信息，所以，一个重要的原则是，不要在<code>payload</code>中存放重要的、敏感的信息。无论是<code>header</code>还是<code>payload</code>，最终都需要通过 <a href="https://www.base64url.com/" target="_blank" rel="noopener">Base64URL</a> 算法将其转化为普通的字符串，该算法和 <a href="https://www.sojson.com/base64.html" target="_blank" rel="noopener">Base64</a> 算法类似，唯一的不同点在于它会对<code>+</code>、<code>/</code> 和 <code>=</code> 这三个符号进行替换，因为这三个符号在网址中有着特殊的含义。</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/zDx765FpRMaP8mK.png" alt="Base64 & Base64URL 算法对比" referrerpolicy="no-referrer"></div><div class="image-caption">Base64 & Base64URL 算法对比</div></figure><p>第三部分，<code>signature</code>，即通常意义上的签名，主要是防止数据篡改。对于 HMAC 系列的加密算法，需要指定一个密钥，以 HMACSHA256 算法为例，其签名函数为：<code>HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret)</code>。对于 RSA 和 ECDSA 这两个系列的加密算法，需要指定公钥和私钥，以 ECDSASHA512 算法为例，其签名函数为：<code>ECDSASHA512(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), PublicKey, PrivateKey)</code>。一旦计算出签名，就可以将这三部分合成一个令牌，而这就是 JWT 的产生原理，而如果我们对第一节中获得的令牌进行解密，我们就会得到下面的结果：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/mpVo8vasYWL4gPN.png" alt="解密 Keycloak 生成的令牌" referrerpolicy="no-referrer"></div><div class="image-caption">解密 Keycloak 生成的令牌</div></figure><p>所以，JSON Web Token 中的 JSON，其实是指 <code>header</code> 和 <code>payload</code> 这两个 JSON 对象，并且我们可以注意到，Keycloak 中生成的令牌实际上携带了更多的信息，例如，客户端、IP 地址、<code>realm_access</code> 以及 <code>resource_access</code>等等，所以。 JWT 其实是一个相对宽松的规范，在实现<code>payload</code>这部分时，可以结合实际场景做更多的扩展，唯一的要求还是那句话，不要在<code>payload</code>中存放重要的、敏感的信息。至此，我们讲清楚了 JWT 的底层原理。</p><p>OK，解释清楚了 JWT，我们再来说 JWKS，这位又是何方神圣呢？我们提到，JWT 至少需要一个密钥或者一对公/私钥来进行签名的校验，因为对于<code>header</code>和<code>payload</code>这两个部分而言，它的加密算法始终都是 Base64URL，所以，我们总是可以反推出原始的 JSON 字符串。接下来，我们只需要按签名函数计算签名即可，对于 HMAC 系列的加密算法，需要指定一个密钥；对于 RSA 和 ECDSA 这两个系列的加密算法，需要指定公钥和私钥。由此，我们就可以计算出一个签名，此时，我们只需要比较两个签名是否一致即可。</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/23/N6ybGazKBUSfE2H.png" alt="JWT 校验过程示意图" referrerpolicy="no-referrer"></div><div class="image-caption">JWT 校验过程示意图</div></figure><p>通过 JWKS 的 <a href="https://auth0.com/docs/tokens/json-web-tokens/json-web-key-sets" target="_blank" rel="noopener">官网</a>，我们可以了解到一件事情，那就是 JWKS 本质上是 Json Web Key Set 的简称，顾名思义，这是一组可以校验任意 JWT 的公钥，并且这些 JWT 必须是通过 RS256 算法进行签名的，RS256 则是我们上面这张图里的 RSA 非对唱加密算法，它需要一个公钥和一个私钥，通常强况下，私钥用来生成签名，公钥用来校验签名。这个 JWKS 呢？同样是一个 JSON 对象，它只有一个属性<code>keys</code>，以 Keycloak 中获得的 JWKS 为例：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/24/lQrXThYCvk9RPLm.png" alt="Keycloak 产生的 JWKS" referrerpolicy="no-referrer"></div><div class="image-caption">Keycloak 产生的 JWKS</div></figure><p>关于 JWKS 的规范，大家可以通过 <a href="https://datatracker.ietf.org/doc/html/rfc7517" target="_blank" rel="noopener">RFC7515</a> 来了解，作为一种通用的规范，Identity Server 4 和 Keycloak 都实现了这一规范，所以，就今天这篇博客而言，不管是哪一种方案，它都可以和 Envoy 配合得天衣无缝。为什么这样说呢？因为我们在 Envoy 中实现 JWT 认证，其核心还是 JWKS 这一套规范。博主没有选择从头开始实现这一切，就在于这个 JWKS 有特别多的细节。总之，我们只需要知道，通过 JWKS 可以对一个令牌进行验证，而 Envoy 刚好有这样一个过滤器，下面是 Envoy 中对应的配置项：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http_filters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.http.jwt_authn</span></span><br><span class="line">    <span class="attr">typed_config:</span></span><br><span class="line">      <span class="string">"@type"</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="attr">jwt_provider:</span></span><br><span class="line">          <span class="attr">issuer:</span> <span class="string">"http://192.168.50.162:7070/auth/realms/master"</span></span><br><span class="line">          <span class="attr">audiences:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"account"</span></span><br><span class="line">          <span class="attr">forward:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">remote_jwks:</span></span><br><span class="line">            <span class="attr">http_uri:</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">"http://192.168.50.162:7070/auth/realms/master/protocol/openid-connect/certs"</span></span><br><span class="line">              <span class="attr">cluster:</span> <span class="string">keycloak</span></span><br><span class="line">              <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">rules:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">            <span class="attr">prefix:</span> <span class="string">"/api/w"</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="attr">provider_name:</span> <span class="string">jwt_provider</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">            <span class="attr">prefix:</span> <span class="string">"/api/c"</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="attr">provider_name:</span> <span class="string">jwt_provider</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.http.router</span></span><br></pre></td></tr></table></figure><p>可以注意到，我们这里配置了一个叫做<code>envoy.filters.http.jwt_authn</code>的过滤器，并为这个过滤器指定了一个叫做<code>jwt_provider</code>的认证提供者，其中的<code>issuer</code>和<code>audiences</code>，我们在讲解 JWT 结构的时候提到过，最为关键的是<code>remote_jwks</code>，我们通过 Keycloak 的服务发现功能，可以获得这个地址，我们将其配置到 Envoy 中即可，Envoy 可以通过它来验证一个 JWT 的令牌，而下面的规则，表示哪些路由需要认证，这里我们假设需要对<code>/api/w</code>和<code>/api/c</code>这两个端点进行认证。所以，可以预见的是，我们可以为整个网关配置统一的认证流程，无论我们有多少个微服务。以往我们都是通过 ASP.NET Core 里的过滤器来实现应用级的认证服务，而此时此刻，我们有了容器级别的认证服务，基础设施从框架提升到了容器层面。除此以外，我们还需要为 Envoy 定义一个集群，这样读取远程 JWKS 的请求才会被正确地转发过去：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clusters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">keycloak</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">STRICT_DNS</span></span><br><span class="line">    <span class="attr">lb_policy:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">    <span class="attr">load_assignment:</span></span><br><span class="line">      <span class="attr">cluster_name:</span> <span class="string">keycloak</span></span><br><span class="line">      <span class="attr">endpoints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">lb_endpoints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">endpoint:</span></span><br><span class="line">            <span class="attr">address:</span></span><br><span class="line">              <span class="attr">socket_address:</span></span><br><span class="line">                <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.50</span><span class="number">.162</span></span><br><span class="line">                <span class="attr">port_value:</span> <span class="number">7070</span></span><br></pre></td></tr></table></figure><p>如此，整个认证服务相关的基础设施均已准备就绪，所谓“万事俱备，只欠东风”，我们还需要定义资源 API 供调用者消费，所以，接下来，我们来看看 API 如何编写。</p><h1 id="编写-API"><a href="#编写-API" class="headerlink" title="编写 API"></a>编写 API</h1><p>编写 API 非常简单，我们直接用 ASP.NET Core 创建两个项目即可，这里是两个服务：<code>CityService</code> 和 <code>WeatherService</code>。</p><p>首先，是 <code>CityService</code>：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line">[<span class="meta">Route(<span class="meta-string">"[controller]"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CityController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span>[] Cities = <span class="keyword">new</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"中卫"</span>, <span class="string">"西安"</span>, <span class="string">"苏州"</span>, <span class="string">"安庆"</span>, <span class="string">"洛阳"</span>, <span class="string">"银川"</span>, <span class="string">"兰州"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;CityController&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CityController</span>(<span class="params">ILogger&lt;CityController&gt; logger</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">dynamic</span> <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      <span class="keyword">var</span> rnd = <span class="keyword">new</span> Random();</span><br><span class="line">      <span class="keyword">var</span> city =  Cities[rnd.Next(Cities.Length)];</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> &#123; City = city, Now = DateTime.Now &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，是 <code>WeatherService</code>：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line">[<span class="meta">Route(<span class="meta-string">"[controller]"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WeatherController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span>[] Summaries = <span class="keyword">new</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"Freezing"</span>, <span class="string">"Bracing"</span>, <span class="string">"Chilly"</span>, <span class="string">"Cool"</span>, <span class="string">"Mild"</span>, <span class="string">"Warm"</span>, <span class="string">"Balmy"</span>, <span class="string">"Hot"</span>, <span class="string">"Sweltering"</span>, <span class="string">"Scorching"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;WeatherController&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherController</span>(<span class="params">ILogger&lt;WeatherController&gt; logger</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerable&lt;WeatherForecast&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      <span class="keyword">var</span> rng = <span class="keyword">new</span> Random();</span><br><span class="line">      <span class="keyword">return</span> Enumerable.Range(<span class="number">1</span>, <span class="number">5</span>).Select(index =&gt; <span class="keyword">new</span> WeatherForecast</span><br><span class="line">      &#123;</span><br><span class="line">        Date = DateTime.Now.AddDays(index),</span><br><span class="line">        TemperatureC = rng.Next(<span class="number">-20</span>, <span class="number">55</span>),</span><br><span class="line">        Summary = Summaries[rng.Next(Summaries.Length)]</span><br><span class="line">      &#125;)</span><br><span class="line">      .ToArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于这两个服务如何实现容器化、反向代理等等的细节，大家可以参考博主前面几篇文章，本文示例已托管到 <a href="https://hub.fastgit.org/Regularly-Archive/2021/tree/master/src/EnvoyJwt" target="_blank" rel="noopener">Github</a>，供大家做进一步的参考。</p><h1 id="服务编排"><a href="#服务编排" class="headerlink" title="服务编排"></a>服务编排</h1><p>这段时间最大的收获便是，学会了通过<code>docker-compose</code>对服务进行编排，虽然目前还有点悬而未决的东西，可一旦接触了这种略显“<strong>高端</strong>”的技巧，便再不愿回到刀耕火种、敲命令行维护<code>docker</code>环境的时代。等有时间了，博主会考虑写一点<code>docker</code>或者<code>docker-compose</code>使用技巧的文章，当然这些都是以后的事情啦！我们要活在当下啊，还是看看这个<code>docker-compose.yaml</code>文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">envoy_gateway:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">Envoy/</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"6060:9090"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"6061:9091"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./Envoy/envoy.yaml:/etc/envoy/envoy.yaml</span></span><br><span class="line">  <span class="attr">city_service:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">CityService/</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8081:80"</span><span class="string">![Envoy-Jwt-Keycloak-16.png](https://i.loli.net/2021/07/24/rCcUBWDyJVtOxkd.png)</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ASPNETCORE_URLS:</span> <span class="string">"http://+"</span></span><br><span class="line">      <span class="attr">ASPNETCORE_ENVIRONMENT:</span> <span class="string">"Development"</span></span><br><span class="line">  <span class="attr">weather_service:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">WeatherService/</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8082:80"</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ASPNETCORE_URLS:</span> <span class="string">"http://+"</span></span><br><span class="line">      <span class="attr">ASPNETCORE_ENVIRONMENT:</span> <span class="string">"Development"</span></span><br><span class="line">  <span class="attr">keycloak:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/keycloak/keycloak:14.0.0</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEYCLOAK_USER:</span> <span class="string">$&#123;KEYCLOAK_USER&#125;</span></span><br><span class="line">      <span class="attr">KEYCLOAK_PASSWORD:</span> <span class="string">$&#123;KEYCLOAK_PASS&#125;</span></span><br><span class="line">      <span class="attr">DB_VENDOR:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">DB_ADDR:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">DB_DATABASE:</span> <span class="string">$&#123;POSTGRESQL_DB&#125;</span></span><br><span class="line">      <span class="attr">DB_USER:</span> <span class="string">$&#123;POSTGRESQL_USER&#125;</span></span><br><span class="line">      <span class="attr">DB_PASSWORD:</span> <span class="string">$&#123;POSTGRESQL_PASS&#125;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"7070:8080"</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13.2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">$&#123;POSTGRESQL_DB&#125;</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">$&#123;POSTGRESQL_USER&#125;</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">$&#123;POSTGRESQL_PASS&#125;</span></span><br></pre></td></tr></table></figure><p>等所有的服务都启动起来以后，我们来验证下这个网关，是不是真的像我们期待的那样。注意到，Envoy 对外暴露出来的端口是<code>6060</code>，这里我们以<code>CItyService</code>为例：</p><p>首先，是不带令牌直接访问接口，我们发现接口返回了<code>401</code>状态码，并提示：<strong>Jwt is missing</strong>。</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/24/Bg5r8dAIbEp4eFy.png" alt="不携带令牌，Envoy 认证失败" referrerpolicy="no-referrer"></div><div class="image-caption">不携带令牌，Envoy 认证失败</div></figure><p>我们带上令牌会怎么样呢？可以注意到，接口成功地返回了数据，这表示我们的目的达到了，这些经由 Envoy 代理的 API 接口，今后都必须携带令牌进行访问：</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://i.loli.net/2021/07/24/rCcUBWDyJVtOxkd.png" alt="携带令牌，Envoy 返回数据" referrerpolicy="no-referrer"></div><div class="image-caption">携带令牌，Envoy 返回数据</div></figure><p>因为 Keycloak 这个认证中心是独立于我们的应用单独存在的，所以，我们可以直接在 Keycloak 中设置令牌的过期时间、为用户分配角色、为不同的资源设置范围等等，而这一切都不需要应用程序或者 Envoy 做任何调整，开发者只需要认真地写好每一个后端服务即可，这是否就是传说中的基础设施即服务呢？</p><h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>本文主要分享了如何利用 Envoy 实现容器级别的 JWT 认证服务，在实现过程中，我们分别了解了 JWT 和 JWKS 这两个概念。其中，JWT 即JSON Web Token，是目前最为流行的跨域认证方案，一个 JWT 通常由 <code>header</code>、<code>payload</code> 和 <code>signature</code> 三个部分组成，JWT 的 JSON 主要体现在<code>header</code>和<code>payload</code>这两个 JSON 对象上，通过 Base64Url 算法实现串化，而 <code>signature</code> 部分则是由<code>header</code>和<code>payload</code>按照签名函数进行生成，主要目的是防止数据篡改。JWKS 可以利用密钥或者公/私钥对令牌进行验证，利用这一原理，Envoy 中集成了 JWKS ，它表示一组可以校验任意 JWT 的公钥，同样是一个 JSON 对象。为了获得可用的 JWKS，我们可以通过 Identity Server 4 或者 Keycloak 中提供的地址来获得这一信息，方便起见，本文选择了更为便捷的 Keycloak。最终，我们实现了一个通用的、容器级别的认证网关，调用方在消费这些 API 资源时都必须带上从认证中心获得的令牌，进而达到保护 API 资源的目的，更好地保障系统和软件安全。</p><div class="recommended_posts"><h1>推荐阅读</h1><ul><li><a href="https://qinyuanpei.github.io/posts/1657075397/">ASP.NET Core gRPC 健康检查的探索与实现</a></li><li><a href="https://qinyuanpei.github.io/posts/2167892202/">ASP.NET Core gRPC 打通前端世界的尝试</a></li><li><a href="https://qinyuanpei.github.io/posts/3942175942/">ASP.NET Core 搭载 Envoy 实现 gRPC 服务代理</a></li><li><a href="https://qinyuanpei.github.io/posts/1519021197/">ASP.NET Core 搭载 Envoy 实现微服务的监控预警</a></li><li><a href="https://qinyuanpei.github.io/posts/3599307335/">ASP.NET Core 搭载 Envoy 实现微服务的反向代理</a></li></ul></div></div><blockquote class="post-copyright" id="post-copyright"><div class="content"><p><b>版权声明：</b> <a href="https://qinyuanpei.github.io/posts/731808750/" rel="external">ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)</a> ，由&nbsp;<a href="/about" target="_blank" rel="external">飞鸿踏雪</a>&nbsp; 首次发表于&nbsp;<a href="/" target="_blank" rel="external">一个人的孤落时辰</a>&nbsp; ，本文地址为：<a href="https://qinyuanpei.github.io/posts/731808750/" target="_blank" rel="external">https://qinyuanpei.github.io/posts/731808750/</a> ，转载请注明 <b>作者</b> 和 <b>出处</b> 。</p></div><footer><a href="https://qinyuanpei.github.io"><img src="https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/images/avatar.jpg" alt="飞鸿踏雪"> 飞鸿踏雪</a></footer></blockquote><div class="page-reward"><a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a></div><div class="post-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Envoy/" rel="tag">Envoy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Keycloak/" rel="tag">Keycloak</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A4%E8%AF%81/" rel="tag">认证</a></li></ul><div class="page-share-wrap"><div class="page-share" id="pageShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://qinyuanpei.github.io/posts/731808750/&title=《ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)》 — 一个人的孤落时辰&pic=https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/images/avatar.jpg" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qinyuanpei.github.io/posts/731808750/&title=《ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)》 — 一个人的孤落时辰&source=一个人的孤落时辰 | 纵有疾风起，人生不言弃 | 隐约雷鸣，阴霾天空，即使天无雨，我亦留此地 | 隐约雷鸣，阴霾天空，但盼风雨来，能留你在此" data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qinyuanpei.github.io/posts/731808750/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)》 — 一个人的孤落时辰&url=https://qinyuanpei.github.io/posts/731808750/&via=https://qinyuanpei.github.io" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://qinyuanpei.github.io/posts/731808750/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li><li><a class="google share-sns" target="_blank" onclick="show_yp()" data-title=" 生成海报"><i class="icon icon-file-image-o"></i></a></li></ul></div><a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle"><i class="icon icon-share-alt icon-lg"></i></a></div></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/posts/3938682696/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">洗衣随想曲</h4></a></div><div class="waves-block waves-effect next"><a href="/posts/673523131/" id="post-next" class="post-nav-link"><div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">浪客剑心：一曲幕末时代的挽歌</h4></a></div></nav><div id="comment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">new Valine({el:"#comment",notify:!1,verify:!0,appId:"JbHqRp2eMrTgIwYpfERH0g79-gzGzoHsz",appKey:"VsiKvLuiBGvJL1XrAfv7siY2",placeholder:"云中谁寄锦书来，雁字回时，月满西楼。&#10;Tips：如果希望收到我的评论回复，请至少留下你的邮箱哦:)",path:"https://qinyuanpei.github.io/posts/731808750/",avatar:"identicon",requiredFields:["nick","mail"]})</script></article><div id="reward" class="page-modal reward-lay"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><h3 class="reward-title"><i class="icon icon-quote-left"></i> 赠人玫瑰，手有余香 <i class="icon icon-quote-right"></i></h3><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master//assets/images/wechat.png" alt="打赏二维码"></div><label class="reward-toggle"><input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master//assets/images/wechat.png" data-alipay="https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master//assets/images/alipay.jpg"><div class="reward-toggle-ctrol"><span class="reward-toggle-item wechat">微信</span> <span class="reward-toggle-label"></span> <span class="reward-toggle-item alipay">支付宝</span></div></label></div></div><script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/yoniu.min.js"></script><style type="text/css">body.active-yp{overflow:hidden}.yp-fc-btn{display:flex;display:-webkit-flex;display:-ms-flexbox;align-items:center;justify-content:space-between;font-size:13px}.yp-fc-btn span{cursor:pointer;padding:2px 10px;color:#4b4b4b;border:#4b4b4b 1px solid;border-radius:5px}#yp-hide{position:fixed;display:flex;display:-webkit-flex;display:-ms-flexbox;justify-content:center;flex-direction:column;left:0;top:0;right:0;bottom:0;background-color:rgba(0,0,0,.5);z-index:99999;visibility:hidden}#yoniu-poster{box-sizing:border-box;width:350px;height:467.2px;background-color:#fff;margin:0 auto;padding:0;line-height:1.6;text-align:justify}.yp-img{min-height:240px;position:relative;display:flex;display:-webkit-flex;display:-ms-flexbox;justify-content:flex-end;flex-direction:column;background-position:50% 50%;background-size:cover;overflow:hidden}.yp-img>div{padding:10px 20px}.yp-name{display:block;color:#fff;font-size:20px;font-weight:600;text-shadow:#4b4b4b .1em .1em .2em;margin-top:10px}.yp-sort{padding:3px 10px;font-size:12px;color:#fff;background:#2e2e2e}.yp-des{color:#2e2e2e;font-size:14px;margin:20px;height:67.2px}.yp-qcode{display:flex;display:-webkit-flex;display:-ms-flexbox;justify-content:space-between;align-items:center;margin:10px;padding:10px 20px;background:#f5f5f5;color:#818181;border-radius:10px}.yp-tips{display:flex;display:-webkit-flex;display:-ms-flexbox;justify-content:space-between;align-items:center;color:#ccc;margin:0 10px 10px;font-size:10px;letter-spacing:1.5px}.yp-btns{display:flex;display:-webkit-flex;display:-ms-flexbox;align-items:stretch;justify-content:center;width:350px;margin:0 auto}.yp-btns>span{display:flex;display:-webkit-flex;display:-ms-flexbox;align-items:center;justify-content:center;font-size:14px;padding:10px 15px;background:rgba(0,0,0,.2);color:#f5f5f5;cursor:pointer}.yp-btns>span>a{color:#f5f5f5}.yp-btns>span>a:hover{text-decoration:none}#yp-close{font-size:18px;font-weight:600}</style><div id="yp-hide"><div id="yoniu-poster"><div class="yp-img" id="yp-img"><div><span class="yp-sort"></span> <span class="yp-name">ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)</span></div></div><div class="yp-des">在构建以 gRPC 为核心的微服务架构的过程中，得益于 Envoy 对 gRPC 的“一等公民”支持，我们可以在过滤器中对 gRPC 服务进行转...</div><div class="yp-qcode"><span>扫描二维码阅读原文</span> <img id="yp-qcode" width="64px" src="//api.qrserver.com/v1/create-qr-code/?data=https://qinyuanpei.github.io/posts/731808750/"></div><div class="yp-tips"><span>一个人的孤落时辰</span> <span><time class="post-time" title="2021-07-25 09:41:24" datetime="2021-07-25T09:41:24.000Z" itemprop="datePublished">2021-07-25</time></span></div></div><div class="yp-btns"><span id="yp-load-yp" onclick="load_yp()">生成海报</span> <span><a id="yp-download"></a></span> <span id="yp-close" onclick="close_yp()">×</span></div></div><script type="text/javascript">function show_yp(){window.scrollTo(0,0),document.body.setAttribute("class","active-yp");let e=document.getElementsByTagName("img")[1];null!=e&&void 0!==e?document.getElementById("yp-img").style.backgroundImage=`url(${e.src})`:document.getElementById("yp-img").style.backgroundColor="#d7dbf0",document.getElementById("yp-hide").style.visibility="visible"}function close_yp(){var e=document.body.getAttribute("class");e=e.replace("active-yp",""),document.body.setAttribute("class",e),document.getElementById("yp-hide").style.visibility="hidden"}function load_yp(){document.getElementById("yp-load-yp").textContent="海报生成中...",setTimeout((function(){h2c_()}),2e3)}</script></div><footer class="footer"><div class="top"><p><span id="lc_counter_container_site_uv"><i class="icon icon-user"></i><span id="lc_counter_value_site_uv"></span> </span><span id="lc_counter_container_site_pv"><i class="icon icon-eye"></i><span id="lc_counter_value_site_pv"></span></span></p><p><a id="jinrishici-sentence" href="https://www.jinrishici.com/" target="_blank" rel="noopener">加载中</a></p><script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script><script>jinrishici.load((function(e){document.querySelector("#subtitle").innerText=e.data.content,document.querySelector("#jinrishici-sentence").innerText=e.data.content}))</script><p><span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span> <span><a href="https://github.com/qinyuanpei" target="_blank" rel="license noopener" title="Github"><i class="icon icon-lg icon-github"></i> </a></span><span><a href="https://weibo.com/1278609231/profile" target="_blank" rel="license noopener" title="微博"><i class="icon icon-lg icon-weibo"></i> </a></span><span><a href="https://www.douban.com/people/60029335/" target="_blank" rel="license noopener" title="豆瓣"><i class="icon icon-lg icon-douban"></i> </a></span><span><a href="https://www.zhihu.com/people/qinyuanpei" target="_blank" rel="license noopener" title="知乎"><i class="icon icon-lg icon-zhihu-square"></i> </a></span><span><a href="https://blog.csdn.net/qinyuanpei" target="_blank" rel="license noopener" title="CSDN"><i class="icon icon-lg">C</i> </a></span><span><a href="https://music.163.com/#/user/home?id=47002864" target="_blank" rel="license noopener" title="网易音乐"><i class="icon icon-lg icon-wangyiyunyinyue"></i></a></span></p></div><div class="bottom"><p><span>飞鸿踏雪 &copy; 2014 - 2021</span><br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & Theme by <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a><br></p><p>Hosted by <a href="https://pages.github.com" target="_blank" rel="noopener" style="font-weight:700">Github Pages</a></p><p></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><div class="global-share" id="globalShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://qinyuanpei.github.io/posts/731808750/&title=《ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)》 — 一个人的孤落时辰&pic=https://cdn.jsdelivr.net/gh/qinyuanpei/blog.yuanpei.me@master/assets/images/avatar.jpg" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qinyuanpei.github.io/posts/731808750/&title=《ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)》 — 一个人的孤落时辰&source=一个人的孤落时辰 | 纵有疾风起，人生不言弃 | 隐约雷鸣，阴霾天空，即使天无雨，我亦留此地 | 隐约雷鸣，阴霾天空，但盼风雨来，能留你在此" data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qinyuanpei.github.io/posts/731808750/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《ASP.NET Core 搭载 Envoy 实现微服务身份认证(JWT)》 — 一个人的孤落时辰&url=https://qinyuanpei.github.io/posts/731808750/&via=https://qinyuanpei.github.io" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://qinyuanpei.github.io/posts/731808750/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li><li><a class="google share-sns" target="_blank" onclick="show_yp()" data-title=" 生成海报"><i class="icon icon-file-image-o"></i></a></li></ul></div><div class="page-modal wx-share" id="wxShare"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><p>扫一扫，分享到微信</p><img src="//api.qrserver.com/v1/create-qr-code/?data=https://qinyuanpei.github.io/posts/731808750/" alt="微信分享二维码"></div><script src="//cdn.bootcss.com/node-waves/0.7.6/waves.min.js"></script><script src="https://cdn.jsdelivr.net/npm/echarts@5.1.2/dist/echarts.min.js"></script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/echarts-wordcloud.min.js" async></script><script>var BLOG={ROOT:"/",SHARE:!0,REWARD:!0}</script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/main.min.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis">{tags}</div><time class="flex-col time">{date}</time></div></a></li></template><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/search.min.js" async></script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/heart.min.js" async></script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/leancloud-counter.min.js"></script><script>(new VisitorCounter).init({appId:"JbHqRp2eMrTgIwYpfERH0g79-gzGzoHsz",appKey:"VsiKvLuiBGvJL1XrAfv7siY2",region:"华北",domain:"",collectIP:!0,collectUA:!0})</script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/vconsole.min.js"></script><script type="text/javascript">if(location.href.indexOf("debug=true")>-1)var vConsole=new VConsole</script><script></script><script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/ribbon.min.js"></script><script>var blocks=document.getElementsByTagName("blockquote");blocks.length>0&&"post-copyright"!=blocks[0].id&&(blocks[0].hidden=!0)</script></body></html>