<!DOCTYPE html>
<html>
<head>
    
    
<script async defer data-domain="blog.yuanpei.me" src="https://plausible.io/js/plausible.js"></script>
    
    <meta charset="utf-8">
    <!-- HTTP 1.1 -->  
    <meta http-equiv="pragma" content="no-cache">  
    <!-- HTTP 1.0 -->  
    <meta http-equiv="cache-control" content="no-cache">
    <!-- 微博图床防盗链 --> 
    <!-- <meta name="referrer" content="no-referrer"/> -->
    <!--Google站点验证-->
    
    <!--百度站点验证-->
    
    
    <!--Google AdSense-->
    
    <!--Bing站点验证-->
    <meta name="msvalidate.01" content="713A48A3FE17D4841C292A6B3942EB4C" />
    
    <title>
        一道 HashSet 面试题引发的蝴蝶效应 | 一个人的孤落时辰 | 纵有疾风起，人生不言弃
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="theme-color" content="#3F51B5">
    

    <meta name="keywords" content="面试,编程,源码,HashSet,秦元培,技术博客,生活随笔,个人博客,NET,Python,数据挖掘,数据分析,NLP">
    
        <meta name="description" content="return (Comparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(GenericComparer&lt;int&gt;), t);return (Comparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(GenericComparer&lt;int&gt;), t);if (other == null) return 1;= null) return -1;= null) return -1">
    
    <meta name="description" content="return (Comparer)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(GenericComparer), t);return (Comparer)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((Runtim">
<meta property="og:type" content="article">
<meta property="og:title" content="一道 HashSet 面试题引发的蝴蝶效应">
<meta property="og:url" content="https://qinyuanpei.github.io/posts/3411909634/index.html">
<meta property="og:site_name" content="一个人的孤落时辰">
<meta property="og:description" content="return (Comparer)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(GenericComparer), t);return (Comparer)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((Runtim">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-10-20T12:19:02.000Z">
<meta property="article:modified_time" content="2021-06-04T03:53:39.969Z">
<meta property="article:author" content="飞鸿踏雪">
<meta property="article:tag" content="面试">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="HashSet">
<meta name="twitter:card" content="summary">
    
        <link rel="alternate" type="application/atom+xml" title="一个人的孤落时辰" href="/atom.xml">
    
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    
        <link rel="manifest" href="/manifest.json">
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master//assets/styles/style.css">
    <script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/instantclick.min.js"></script>
    <script>window.lazyScripts=[]</script>
    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/assets/images/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/assets/images/avatar.jpg" alt="avatar">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">飞鸿踏雪</h5>
          <a href="mailto:qinyuanpei@163.com" title="qinyuanpei@163.com" class="mail">qinyuanpei@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/books"  >
                <i class="icon icon-lg icon-bookmark"></i>
                书单
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/movies"  >
                <i class="icon icon-lg icon-film"></i>
                影单
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/works"  >
                <i class="icon icon-lg icon-code"></i>
                实验室
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-circle"></i>
                关于我
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
            <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">一道 HashSet 面试题引发的蝴蝶效应</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off"
                placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
        <a href="https://github.com/qinyuanpei/qinyuanpei.github.io" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="menuGithub">
            <i class="icon icon-lg icon-code-fork"></i>
        </a>
    </div>
</header>
<header class="content-header post-header">
    <div class="container fade-scale">
        <h1 class="title">一道 HashSet 面试题引发的蝴蝶效应</h1>
        <h5 class="subtitle" id="subtitle">
            
            <time datetime="2020-10-20T12:19:02.000Z" itemprop="datePublished" class="page-time">
  2020-10-20
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li></ul>

            
        </h5>
    </div>
    

</header>

<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>目录</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#HashSet源代码解读"><span class="post-toc-number">1.</span> <span class="post-toc-text">HashSet源代码解读</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#IEqualityComparer接口"><span class="post-toc-number">2.</span> <span class="post-toc-text">IEqualityComparer接口</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#排序与去重是亲家"><span class="post-toc-number">3.</span> <span class="post-toc-text">排序与去重是亲家</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#IEquatable接口"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">IEquatable接口</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ICompareable-ICompareable接口"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">ICompareable&#x2F;ICompareable接口</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#IComparer接口"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">IComparer接口</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#本文小结"><span class="post-toc-number">4.</span> <span class="post-toc-text">本文小结</span></a></li></ol>
        </nav>
    </aside>
    
    <article id="post-一道HashSet面试题引发的蝴蝶效应" class="post-article article-type-post fade" itemprop="blogPost">

        <div class="post-card">
            <h1 class="post-card-title">
                一道 HashSet 面试题引发的蝴蝶效应
            </h1>
            <div class="post-meta">
                <time class="post-time" title="2020-10-20 12:19:02" datetime="2020-10-20T12:19:02.000Z"  itemprop="datePublished">2020-10-20</time>

                
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li></ul>



                
<span id="lc_counter_container_page_pv" title="文章总阅读量" data-page-url="" data-page-title="一道 HashSet 面试题引发的蝴蝶效应">
    <i class="icon icon-eye icon-pr"></i><span id="lc_counter_value_page_pv"></span>
</span>





                
    <span>
        <i class="icon icon-clock-o"></i>
        30 min.
    </span>
    
            </div>
            <div class="post-content" id="post-content" itemprop="postContent">
                <p>没错，我又借着“面试题”的名头来搞事情了，今天要说的是 HashSet ，而这确实是一个实际面试中遇到的问题。当时的场景大概是这样的，面试官在了解了你的知识广度以后，决心来考察一番你的基本功底，抛出了一个看起来平平无奇的问题：说一说你平时工作中都用到了哪些数据结构。你心想，这还不简单，<code>Array</code>、<code>ArrayList</code>、<code>List</code>、<code>Dictionary</code>、<code>HashSet</code>、<code>Stack</code>、<code>Queue</code>…等等各种集合类简直如数家珍，甚至你还能说出这些数据结构间的优劣以及各自使用的场景。可没想到，面试官话锋一转，直接来一句，“你能说说HashSet去重的原理吗”，好家伙，你这简直不按套路出牌啊…本着每次面试都有一点收获的初心，于是就有了今天这篇博客，不同的是，顺着这个思路继续深挖下去，博主又发现了几个平时关注不到的技术盲点，所以，博主称之为：一道 HashSet 面试题引发的蝴蝶效应。</p>
<h1 id="HashSet源代码解读"><a href="#HashSet源代码解读" class="headerlink" title="HashSet源代码解读"></a>HashSet源代码解读</h1><p>OK，首先，我们来回答第一个问题，即：<strong>HashSet去重的原理是什么？</strong>。为此，博主翻阅了 HashSet 的 <a href="https://referencesource.microsoft.com/#System.Core/System/Collections/Generic/HashSet.cs,1044" target="_blank" rel="noopener">源代码</a>。首先，我们会注意到 HashSet 的构造函数，它需要一个类型为<code>IEqualityComparer&lt;T&gt;</code>的参数。从这个命名上我们就可以知道，这是一个用于相等性比较的接口，我们初步推测，HashSet 去重应该和这个接口有关：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    : <span class="title">this</span>(<span class="params">EqualityComparer&lt;T&gt;.Default</span>)</span> &#123; &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span>(<span class="params"><span class="keyword">int</span> capacity</span>)</span></span><br><span class="line"><span class="function">    : <span class="title">this</span>(<span class="params">capacity, EqualityComparer&lt;T&gt;.Default</span>)</span> &#123; &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span>(<span class="params">IEqualityComparer&lt;T&gt; comparer</span>)</span> &#123; &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span>(<span class="params">IEnumerable&lt;T&gt; collection</span>)</span></span><br><span class="line"><span class="function">    : <span class="title">this</span>(<span class="params">collection, EqualityComparer&lt;T&gt;.Default</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span>(<span class="params">IEnumerable&lt;T&gt; collection, IEqualityComparer&lt;T&gt; comparer</span>)</span></span><br><span class="line"><span class="function">    : <span class="title">this</span>(<span class="params">comparer</span>)</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>我们都知道 HashSet 可以去重，比如，我们向 HashSet 添加多个相同的元素，实际上 HashSet 中最终只会有一个元素。所以，我们自然而然地想到，看看 HashSet 中的 <code>Add()</code> 方法呗，或许能从这里看出一点端倪。HashSet 中一共有两个 <code>Add()</code> 方法，它们内部都调用了 <code>AddIfNotPresent()</code> 方法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ICollection&lt;T&gt;.Add(T item) &#123;</span><br><span class="line">    AddIfNotPresent(item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Add</span>(<span class="params">T item</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> AddIfNotPresent(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续循着蛛丝马迹一路 F12 ，我们来看看这个方法的具体实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">AddIfNotPresent</span>(<span class="params">T <span class="keyword">value</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buckets == <span class="literal">null</span>) &#123;</span><br><span class="line">        Initialize(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> hashCode = InternalGetHashCode(<span class="keyword">value</span>);</span><br><span class="line">    <span class="keyword">int</span> bucket = hashCode % m_buckets.Length;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> FEATURE_RANDOMIZED_STRING_HASHING &amp;&amp; !FEATURE_NETCORE</span></span><br><span class="line">        <span class="keyword">int</span> collisionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m_buckets[hashCode % m_buckets.Length] - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i = m_slots[i].next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_slots[i].hashCode == hashCode &amp;&amp; m_comparer.Equals(m_slots[i].<span class="keyword">value</span>, <span class="keyword">value</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> FEATURE_RANDOMIZED_STRING_HASHING &amp;&amp; !FEATURE_NETCORE</span></span><br><span class="line">            collisionCount++;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">if</span> (m_freeList &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        index = m_freeList;</span><br><span class="line">        m_freeList = m_slots[index].next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_lastIndex == m_slots.Length) &#123;</span><br><span class="line">            IncreaseCapacity();</span><br><span class="line">            <span class="comment">// this will change during resize</span></span><br><span class="line">            bucket = hashCode % m_buckets.Length;</span><br><span class="line">        &#125;</span><br><span class="line">        index = m_lastIndex;</span><br><span class="line">        m_lastIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">    m_slots[index].hashCode = hashCode;</span><br><span class="line">    m_slots[index].<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">    m_slots[index].next = m_buckets[bucket] - <span class="number">1</span>;</span><br><span class="line">    m_buckets[bucket] = index + <span class="number">1</span>;</span><br><span class="line">    m_count++;</span><br><span class="line">    m_version++;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> FEATURE_RANDOMIZED_STRING_HASHING &amp;&amp; !FEATURE_NETCORE</span></span><br><span class="line">        <span class="keyword">if</span> (collisionCount &gt; HashHelpers.HashCollisionThreshold &amp;&amp; HashHelpers.IsWellKnownEqualityComparer(m_comparer)) &#123;</span><br><span class="line">            m_comparer = (IEqualityComparer&lt;T&gt;) HashHelpers.GetRandomizedEqualityComparer(m_comparer);</span><br><span class="line">            SetCapacity(m_buckets.Length, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> // FEATURE_RANDOMIZED_STRING_HASHING</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以注意到，在这段代码中，首先，会通过 <code>InternalGetHashCode()</code> 方法计算一个 HashCode。其中，<code>Lower31BitMask</code> 是一个常量 <code>0x7FFFFFFF</code> ：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">InternalGetHashCode</span>(<span class="params">T item</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> m_comparer.GetHashCode(item) &amp; Lower31BitMask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，在 HashSet 内部使用了<code>Slot</code> 这个结构来存储元素，该结构设计上类似于链表，每一个 <code>Slot</code> 中都记录对应元素的值、HashCode 以及下一个元素的索引。所以，只需要对它做一次遍历，如果对应元素的 HashCode 和 值 都相等，则认为该元素在 HashSet中已经存在了。此时，<code>AddIfNotPresent()</code> 方法会返回 false。这就是 HashSet 去重的原理啦。在比较元素的值是否相等的时候，我们前面提到的 <code>IEqualityComparer&lt;T&gt;</code> 终于登场，它提供的 <code>Equals()</code> 方法恰好可以比较两个元素是否相等：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">struct</span> Slot &#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">int</span> hashCode;  <span class="comment">// Lower 31 bits of hash code, -1 if unused</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">int</span> next;  <span class="comment">// Index of next entry, -1 if last</span></span><br><span class="line">    <span class="keyword">internal</span> T <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public interface IEqualityComparer&lt;in T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params">T x, T y</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetHashCode</span>(<span class="params">T obj</span>)</span>;                </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再接下来，如果对应元素的 HashCode 或 值 都不相等，则认为该元素在 HashSet 中不存在。此时，需要考虑 HashSet 的容量是否足以放得下这个新元素。在容量不满足的情况下，就需要对 HashSet 进行扩容。值得一提的是，这里是使用质数进行扩容的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">IncreaseCapacity</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    Debug.Assert(m_buckets != <span class="literal">null</span>, <span class="string">"IncreaseCapacity called on a set with no elements"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> newSize = HashHelpers.ExpandPrime(m_count);</span><br><span class="line">    <span class="keyword">if</span> (newSize &lt;= m_count) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(SR.GetString(SR.Arg_HSCapacityOverflow));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Able to increase capacity; copy elements to larger array and rehash</span></span><br><span class="line">    SetCapacity(newSize, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ExpandPrime</span>(<span class="params"><span class="keyword">int</span> oldSize</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newSize = <span class="number">2</span> * oldSize;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Allow the hashtables to grow to maximum possible size (~2G elements) before encoutering capacity overflow.</span></span><br><span class="line">    <span class="comment">// Note that this check works even when _items.Length overflowed thanks to the (uint) cast</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">uint</span>)newSize &gt; MaxPrimeArrayLength &amp;&amp; MaxPrimeArrayLength &gt; oldSize)</span><br><span class="line">    &#123;</span><br><span class="line">        Contract.Assert( MaxPrimeArrayLength == GetPrime(MaxPrimeArrayLength), <span class="string">"Invalid MaxPrimeArrayLength"</span>);</span><br><span class="line">        <span class="keyword">return</span> MaxPrimeArrayLength;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> GetPrime(newSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="IEqualityComparer接口"><a href="#IEqualityComparer接口" class="headerlink" title="IEqualityComparer接口"></a>IEqualityComparer<T>接口</h1><p>OK，现在我们知道了，HashSet 之所以可以去重，一个重要的原因是 <code>IEqualityComparer&lt;T&gt;</code> 。而回到这个接口本身呢，它只有 <code>Equals()</code> 和 <code>GetHashCode()</code>，这其实非常符合我们的认知，因为这两个方法在对象相等的场景中十分常见，有一个准则是：如果重写了 <code>Equals()</code> 方法，那么，应该同时去重写 <code>GetHashCode()</code> 方法，即，两者在表达相等这个含义时应该具有一致性。这里可能会有一点疑问，那就是，我们平时使用 HashSet 的时候，完全不需要指定 <code>IEqualityComparer&lt;T&gt;</code> ，它一样可以正常工作啊？没错，这是因为微软提供了一个默认的实现：<code>EqualityComparer&lt;T&gt;.Default</code>。我们同样来看看它的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> EqualityComparer&lt;T&gt; <span class="title">CreateComparer</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    Contract.Ensures(Contract.Result&lt;EqualityComparer&lt;T&gt;&gt;() != <span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line">    RuntimeType t = (RuntimeType)<span class="keyword">typeof</span>(T);</span><br><span class="line">    <span class="comment">// Specialize type byte for performance reasons</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">typeof</span>(<span class="keyword">byte</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)(<span class="keyword">object</span>)(<span class="keyword">new</span> ByteEqualityComparer());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If T implements IEquatable&lt;T&gt; return a GenericEqualityComparer&lt;T&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span>(IEquatable&lt;T&gt;).IsAssignableFrom(t)) &#123;</span><br><span class="line">        <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(GenericEqualityComparer&lt;<span class="keyword">int</span>&gt;), t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If T is a Nullable&lt;U&gt; where U implements IEquatable&lt;U&gt; return a NullableEqualityComparer&lt;U&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (t.IsGenericType &amp;&amp; t.GetGenericTypeDefinition() == <span class="keyword">typeof</span>(Nullable&lt;&gt;)) &#123;</span><br><span class="line">        RuntimeType u = (RuntimeType)t.GetGenericArguments()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(IEquatable&lt;&gt;).MakeGenericType(u).IsAssignableFrom(u)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(NullableEqualityComparer&lt;<span class="keyword">int</span>&gt;), u);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// See the METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST and METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST_LONG cases in getILIntrinsicImplementation</span></span><br><span class="line">    <span class="keyword">if</span> (t.IsEnum) &#123;</span><br><span class="line">        TypeCode underlyingTypeCode = Type.GetTypeCode(Enum.GetUnderlyingType(t));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Depending on the enum type, we need to special case the comparers so that we avoid boxing</span></span><br><span class="line">        <span class="comment">// Note: We have different comparers for Short and SByte because for those types we need to make sure we call GetHashCode on the actual underlying type as the </span></span><br><span class="line">        <span class="comment">// implementation of GetHashCode is more complex than for the other types.</span></span><br><span class="line">        <span class="keyword">switch</span> (underlyingTypeCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> TypeCode.Int16: <span class="comment">// short</span></span><br><span class="line">               <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(ShortEnumEqualityComparer&lt;<span class="keyword">short</span>&gt;), t);</span><br><span class="line">            <span class="keyword">case</span> TypeCode.SByte:</span><br><span class="line">                <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(SByteEnumEqualityComparer&lt;<span class="keyword">sbyte</span>&gt;), t);</span><br><span class="line">            <span class="keyword">case</span> TypeCode.Int32:</span><br><span class="line">            <span class="keyword">case</span> TypeCode.UInt32:</span><br><span class="line">            <span class="keyword">case</span> TypeCode.Byte:</span><br><span class="line">            <span class="keyword">case</span> TypeCode.UInt16: <span class="comment">//ushort</span></span><br><span class="line">                <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(EnumEqualityComparer&lt;<span class="keyword">int</span>&gt;), t);</span><br><span class="line">            <span class="keyword">case</span> TypeCode.Int64:</span><br><span class="line">            <span class="keyword">case</span> TypeCode.UInt64:</span><br><span class="line">                <span class="keyword">return</span> (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(LongEnumEqualityComparer&lt;<span class="keyword">long</span>&gt;), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise return an ObjectEqualityComparer&lt;T&gt;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectEqualityComparer&lt;T&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，<code>EqualityComparer&lt;T&gt;</code> 类是一个抽象类，实现了 <code>IEqualityComparer&lt;T&gt;</code> 接口。简单来说，对于简单类型如整型、字节型等，微软实现了相应的 <code>IEqualityComparer&lt;T&gt;</code> 接口；而对于复杂的类型，微软提供了 <code>ObjectEqualityComparer&lt;T&gt;</code> 这一实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">internal class ObjectEqualityComparer&lt;T&gt;: EqualityComparer&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Pure</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params">T x, T y</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (y != <span class="literal">null</span>) <span class="keyword">return</span> x.Equals(y);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (y != <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    [<span class="meta">Pure</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">GetHashCode</span>(<span class="params">T obj</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> obj.GetHashCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，现在又回到我们刚刚聊起的话题，为什么说一个类型的 <code>Equals()</code> 和 <code>GetHashCode()</code> 方法非常重要呢？因为如果我们不能正确地实现这两个方法，微软实现的这个  <code>ObjectEqualityComparer&lt;T&gt;</code> 就会出现问题，导致 HashSet 在判断元素是否存在时出现问题，所以，这是一系列的连锁反应。有人可能会问，博主你说的这个好夸张耶，像我就从来没有重写过这两个方法。OK，现在来回答我的一个问题，如果你定义了一个类型 <code>Foo</code> ，并尝试用它作为一个字典中的 Key ，那么，你觉得这个字典应该怎么判断这个 Key 是否存在呢？我觉得这是一个好问题，因为它引发了我们在 .NET 知识体系中的蝴蝶效应。</p>
<h1 id="排序与去重是亲家"><a href="#排序与去重是亲家" class="headerlink" title="排序与去重是亲家"></a>排序与去重是亲家</h1><p>排序与去重，在我看来是亲家关系，因为两者都需要“比较”。所以，下面我想从 .NET 中选取一部分接口来阐述我的观点，以及当我们有了 LINQ 以后，是否就应该抛弃它们。可能这些接口大家平时都用不到多少，但我还是想花点时间来梳理这些知识盲点，因为我发现，与其为整个行业35岁的的职业生涯而焦虑，倒不如重新捡起这个行业的初心，好好地学一学数据结构、算法和数学。整个行业的火热，容易让每一个人都陷入一种“我非常厉害”的错觉，我写博客的时候，在心里想了这样一句话：<strong>战士上战场，整天就知道CRUD，连HashSet都不知道，早晚是个死</strong>。用王布斯的口吻说出来，会不会有一种紧迫感呢？</p>
<h2 id="IEquatable接口"><a href="#IEquatable接口" class="headerlink" title="IEquatable接口"></a>IEquatable<T>接口</h2><p><code>IEquatable&lt;T&gt;</code> 接口在微软官方文档中的定义是，<strong>定义值类型或类实现的通用方法，以创建用于确定实例相等性的类型特定方法</strong>。我承认，这不是一个特别好的定义，不过，我们可以换个角度来审视这个接口存在的意义。虽然 <code>Object</code> 这个基类提供了 <code>Equals()</code> 方法，但是这个方法只能接受一个 <code>object</code> 类型的参数， 所以，它本身会面临<strong>类型安全性缺失</strong>和<strong>装箱</strong>两个问题。为了解决这个问题，就必须要定义一个新的 <code>Equals()</code> 方法，确保它可以接收和当前类型一致的参数，所以就需要这样一个接口，你可以理解为它是 <code>Equals()</code> 方法的泛型版本，而众所周知 C# 是一门不支持多继承的语言，所以，这里只能以接口的形式提供出来。这里说一下我的结论，<code>IEquatable&lt;T&gt;</code> 接口对值类型更有用一点，相反，对引用类型就没有那么有用，因为它没有考虑到协变的问题，对引用类型的继承相对无力。下面是一个简单的例子：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义类型Foo，实现IEquatable&lt;Foo&gt;接口</span></span><br><span class="line">public class Foo : IEquatable&lt;Foo&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> Weight &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params"><span class="keyword">object</span> other</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> Equals(other <span class="keyword">as</span> Foo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params">Foo other</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (other == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.Value == other.Value &amp;&amp; <span class="keyword">this</span>.Weight == other.Weight);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//平平无奇的代码</span></span><br><span class="line"><span class="keyword">var</span> foo1 = <span class="keyword">new</span> Foo() &#123; Value = <span class="number">10</span>, Weight = <span class="number">1.0</span>M &#125;;</span><br><span class="line"><span class="keyword">var</span> foo2 = <span class="keyword">new</span> Foo() &#123; Value = <span class="number">10</span>, Weight = <span class="number">1.0</span>M &#125;;</span><br><span class="line">Assert.AreEqual(<span class="literal">true</span>, foo1.Equals(foo2));</span><br></pre></td></tr></table></figure>

<h2 id="ICompareable-ICompareable接口"><a href="#ICompareable-ICompareable接口" class="headerlink" title="ICompareable/ICompareable接口"></a>ICompareable/ICompareable<T>接口</h2><p><code>ICompareable</code> 和 <code>ICompareable&lt;T&gt;</code>是是同一个接口的非泛型与泛型版本，都需要实现 <code>CompareTo()</code> 方法。可能大家会觉得这几个接口都差不多啊，实际上，大家细心观察就能发现它们的区别，“相等”这一类的接口的返回值是布尔型，关注的是两个对象是否相等；而“比较”这一类的接口的返回值是整数型，关注的是哪个大哪个小。我们继续以 <code>Foo</code> 这个类型为例，分别实现<code>IComparerable</code>  和 <code>IComparerable&lt;T&gt;</code>两个接口：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//继续实现IComparable, IComparable&lt;Foo&gt;接口</span></span><br><span class="line">public class Foo : IEquatable&lt;Foo&gt;, IComparable, IComparable&lt;Foo&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> Weight &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params"><span class="keyword">object</span> other</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> Equals(other <span class="keyword">as</span> Foo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params">Foo other</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (other == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.Value == other.Value &amp;&amp; <span class="keyword">this</span>.Weight == other.Weight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">CompareTo</span>(<span class="params"><span class="keyword">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> other = obj <span class="keyword">as</span> Foo;</span><br><span class="line">        <span class="keyword">return</span> CompareTo(other);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">CompareTo</span>(<span class="params">[AllowNull] Foo other</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (other == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)((Value * Weight) - (other.Value * other.Weight));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//平平无奇的代码</span></span><br><span class="line"><span class="keyword">var</span> foo1 = <span class="keyword">new</span> Foo() &#123; Value = <span class="number">10</span>, Weight = <span class="number">1.0</span>M &#125;;</span><br><span class="line"><span class="keyword">var</span> foo2 = <span class="keyword">new</span> Foo() &#123; Value = <span class="number">20</span>, Weight = <span class="number">1.0</span>M &#125;;</span><br><span class="line">Assert.IsTrue(foo2.CompareTo(foo1) &gt; <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h2 id="IComparer接口"><a href="#IComparer接口" class="headerlink" title="IComparer接口"></a>IComparer<T>接口</h2><p>对于排序来说，理论上有<code>ICompareable</code> 和 <code>ICompareable&lt;T&gt;</code>这两个接口就可以了，为什么还要再定义一组接口呢？其实，我们结合生活中的场景就能想明白，不管是判断两个对象是否相等，还是对两个对象进行排序，这些条件都属于“变量”。<code>ICompareable</code> 和 <code>ICompareable&lt;T&gt;</code>这两个接口设计上的确没什么问题，但这都是一锤子买卖，一旦实现了对应的接口，就意味着如何比较两个对象的逻辑是确定好了的。可生活常识告诉我们，同一组信息不同的人考虑的维度是不一样的，譬如学生的成绩，可以按照某一个科目的成绩来排序，还可以按照各个科目的总成绩甚至是平均分来排序。对于上面的类型 <code>Foo</code>，我们不妨考虑按照 <code>Value</code> 和 <code>Weight</code> 分别进行排序，此时可以这样写：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//按Value排序</span></span><br><span class="line">public class FooValueComparer : IComparer&lt;Foo&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Compare</span>(<span class="params">[AllowNull] Foo x, [AllowNull] Foo y</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> &amp;&amp; y == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (x != <span class="literal">null</span> &amp;&amp; y == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> &amp;&amp; y != <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(x.Value - y.Value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//按Weight排序</span></span><br><span class="line">public class FooWeightComparer : IComparer&lt;Foo&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Compare</span>(<span class="params">[AllowNull] Foo x, [AllowNull] Foo y</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> &amp;&amp; y == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (x != <span class="literal">null</span> &amp;&amp; y == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> &amp;&amp; y != <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(x.Weight - y.Weight);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//平平无奇的代码</span></span><br><span class="line"><span class="keyword">var</span> list= <span class="keyword">new</span> List&lt;Foo&gt;&#123;</span><br><span class="line">    <span class="keyword">new</span> Foo() &#123; Value = <span class="number">10</span>, Weight = <span class="number">2.0</span>M &#125;,</span><br><span class="line">    <span class="keyword">new</span> Foo() &#123; Value = <span class="number">10</span>, Weight = <span class="number">1.0</span>M &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用默认的排序器</span></span><br><span class="line">list.Sort(); </span><br><span class="line"></span><br><span class="line"><span class="comment">//按Value进行排序</span></span><br><span class="line">list.Sort(<span class="keyword">new</span> FooValueComparer());</span><br><span class="line">list.OrderBy(x =&gt; x.Value);</span><br><span class="line"></span><br><span class="line"><span class="comment">//按Weight进行排序</span></span><br><span class="line">list.Sort(<span class="keyword">new</span> FooWeightComparer());</span><br><span class="line">list.OrderBy(x =&gt; x.Weight);</span><br></pre></td></tr></table></figure>
<p>在这里有一个点是，在不指定排序器的时候，微软帮我们提供了一个默认的排序器。而这个默认排序器会遵循这样的策略。如果类型 T 实现了 <code>IComparable&lt;T&gt;</code> 接口，则返回 <code>GenericComparer&lt;int&gt;</code> 实例；如果类型 T 实现是一个可空类型 <code>Nullable&lt;U&gt;</code> 并且类型 U 实现了 <code>IComparable&lt;T&gt;</code> 接口，则返回 <code>NullableComparer&lt;int&gt;</code> 实例；否则返回 <code>ObjectComparer&lt;T&gt;</code> 实例。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Comparer&lt;T&gt; <span class="title">CreateComparer</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    RuntimeType t = (RuntimeType)<span class="keyword">typeof</span>(T);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// If T implements IComparable&lt;T&gt; return a GenericComparer&lt;T&gt;</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> FEATURE_LEGACYNETCF</span></span><br><span class="line">        <span class="comment">// Pre-Apollo Windows Phone call the overload that sorts the keys, not values this achieves the same result</span></span><br><span class="line">        <span class="keyword">if</span> (CompatibilitySwitches.IsAppEarlierThanWindowsPhone8) &#123;</span><br><span class="line">            <span class="keyword">if</span> (t.ImplementInterface(<span class="keyword">typeof</span>(IComparable&lt;T&gt;))) &#123;</span><br><span class="line">                <span class="keyword">return</span> (Comparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(GenericComparer&lt;<span class="keyword">int</span>&gt;), t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span>(IComparable&lt;T&gt;).IsAssignableFrom(t)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Comparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(GenericComparer&lt;<span class="keyword">int</span>&gt;), t);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// If T is a Nullable&lt;U&gt; where U implements IComparable&lt;U&gt; return a NullableComparer&lt;U&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (t.IsGenericType &amp;&amp; t.GetGenericTypeDefinition() == <span class="keyword">typeof</span>(Nullable&lt;&gt;)) &#123;</span><br><span class="line">        RuntimeType u = (RuntimeType)t.GetGenericArguments()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(IComparable&lt;&gt;).MakeGenericType(u).IsAssignableFrom(u)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Comparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(NullableComparer&lt;<span class="keyword">int</span>&gt;), u);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Otherwise return an ObjectComparer&lt;T&gt;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectComparer&lt;T&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更有意思的是，<code>GenericComparer&lt;T&gt;</code> 就是利用 <code>IComparable&lt;T&gt;</code> 的 <code>CompareTo()</code> 方法来说实现的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">internal class GenericComparer&lt;T&gt; : Comparer&lt;T&gt; where T: IComparable&lt;T&gt;</span><br><span class="line">&#123;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">Compare</span>(<span class="params">T x, T y</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (y != <span class="literal">null</span>) <span class="keyword">return</span> x.CompareTo(y);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span> (y != <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Equals method for the comparer itself. </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Equals</span>(<span class="params">Object obj</span>)</span>&#123;</span><br><span class="line">        GenericComparer&lt;T&gt; comparer = obj <span class="keyword">as</span> GenericComparer&lt;T&gt;;</span><br><span class="line">        <span class="keyword">return</span> comparer != <span class="literal">null</span>;</span><br><span class="line">    &#125;        </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">GetHashCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.GetType().Name.GetHashCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们有了 <code>LINQ</code> 以后，通过 <code>OrderBy</code> 和 <code>OrderByDescending</code> 就可以进行排序，如果这个排序字段是一个简单类型，比如字符型、整型、日期型，这些简单类型微软都已经实现了相应的“排序”逻辑，而如果这个排序字段是一个复杂类型，比如一个自定义的类或者结构，此时，为了让这些方法能够“适应”这些复杂类型，最好的还是去实现 <code>IComparer&lt;T&gt;</code> 或者 <code>ICompareable&lt;T&gt;</code> 接口，然后传递给这两个排序方法。类似地，还有 <code>Distinct</code> 这个方法，它接收一个 <code>IEqualityComparer&lt;T&gt;</code> 类型的参数，所以，当你对一个列表进行去重(<strong>Distinct</strong>)操作时，千万不要想当然地人为它会按照你的期望去去重，如果结果不符合你的期望，很大原因是你没有给它提供一个合适的<code>IEqualityComparer&lt;T&gt;</code> 。所以，你看，我们绕了一大圈，从 HashSet 说到 <code>IEqualityComparer&lt;T&gt;</code>，又从排序说到去重，最终又回到了起点，这是多么有趣的一件事情。而去重(<strong>Distinct</strong>)这件事情，其实涉及到<code>Dictionary</code> 和 <code>HashSet</code> 两个数据结构，通过结构来推演性质，又通过性质来扫清盲点，这可能是这段时间刷LeetCode最大的一个收获吧！</p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>面试中偶然遇到的 HashSet 问题，让我发现自己的知识体系中存在着盲点。通过解读 HashSet 源代码，我们认识到 HashSet 可以去重的一个重要原因是<code>IEqualityComparer&lt;T&gt;</code> 接口，它决定了两个对象的实例在什么情况下可以被判定为相等。而这个接口，不单单在 HashSet 出现，在 Dictionary 中同样会出现，甚至在我们最熟悉不过的去重(<strong>Distinct</strong>)中还会出现，所以，通过 HashSet 这一个点上的疑问，我搞清楚了很多相关联的内容，这不是蝴蝶效应又是什么呢？而与去重(<strong>Distinct</strong>)相关联的则是排序，在此基础上，对 <code>IEquatable&lt;T&gt;</code> 接口、<code>ICompareable</code>/<code>ICompareable&lt;T&gt;</code> 接口、<code>IComparer&lt;T&gt;</code> 接口等知识盲点进行梳理。总而言之，排序需要关注的是 <code>ICompareable</code>/<code>ICompareable&lt;T&gt;</code> 接口、<code>IComparer&lt;T&gt;</code> 接口，去重需要关注的是 <code>IEqualityComparer&lt;T&gt;</code> 接口。好了，今天的这只蝴蝶就飞到这里，欢迎大家在博客中留言，谢谢大家！</p>

                

                


<div class="recommended_posts">
    <h1>推荐阅读</h1>
    <ul>
        
        <li><a href="https://qinyuanpei.github.io/posts/123663202/">剑指Offer读书笔记(1)</a></li>
        
        <li><a href="https://qinyuanpei.github.io/posts/2837181325/">记一次失败的 ThoughtWorks 面试经历</a></li>
        
        <li><a href="https://qinyuanpei.github.io/posts/2041685704/">C#中Socket通信编程的异步实现</a></li>
        
        <li><a href="https://qinyuanpei.github.io/posts/345410188/">《C#多线程编程实战》读书笔记</a></li>
        
        <li><a href="https://qinyuanpei.github.io/posts/2637069146/">低代码，想说爱你不容易</a></li>
        
    </ul>
</div>

            </div>
            
<blockquote class="post-copyright">
    <div class="content">
        <p><b>版权声明：</b>
        <a href="https://qinyuanpei.github.io/posts/3411909634/" rel="external">一道 HashSet 面试题引发的蝴蝶效应</a>
        ，由&nbsp;<a href="/about" target="_blank" rel="external">飞鸿踏雪</a>&nbsp;
        首次发表于&nbsp;<a href="/" target="_blank" rel="external">一个人的孤落时辰</a>&nbsp;
        ，本文地址为：<a href="https://qinyuanpei.github.io/posts/3411909634/" target="_blank" rel="external">https://qinyuanpei.github.io/posts/3411909634/</a>
        ，转载请注明<b>作者</b>和<b>出处</b>。</p>
    </div>
    <footer>
        <a href="https://qinyuanpei.github.io">
            <img src="/assets/images/avatar.jpg" alt="飞鸿踏雪">
            飞鸿踏雪
        </a>
    </footer>
</blockquote>


            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>


            <div class="post-footer">
                
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HashSet/" rel="tag">HashSet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>

                
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://qinyuanpei.github.io/posts/3411909634/&title=《一道 HashSet 面试题引发的蝴蝶效应》 — 一个人的孤落时辰&pic=https://qinyuanpei.github.ioassets/images/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qinyuanpei.github.io/posts/3411909634/&title=《一道 HashSet 面试题引发的蝴蝶效应》 — 一个人的孤落时辰&source=一个人的孤落时辰 | 纵有疾风起，人生不言弃 | 隐约雷鸣，阴霾天空，即使天无雨，我亦留此地。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qinyuanpei.github.io/posts/3411909634/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《一道 HashSet 面试题引发的蝴蝶效应》 — 一个人的孤落时辰&url=https://qinyuanpei.github.io/posts/3411909634/&via=https://qinyuanpei.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://qinyuanpei.github.io/posts/3411909634/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" onClick="show_yp()" data-title=" 生成海报">
          <i class="icon icon-file-image-o"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>


            </div>
        </div>

        
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/posts/3672690776/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">使用 dotTrace 对 .NET 应用进行性能分析与优化</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/posts/1085014581/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">当姜子牙遇见朱一旦</h4>
      </a>
    </div>
  
</nav>


        
    <div id="comment"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script type="text/javascript">
new Valine({
    el: '#comment' ,
    notify: false, 
    verify: true, 
    appId: 'JbHqRp2eMrTgIwYpfERH0g79-gzGzoHsz',
    appKey: 'VsiKvLuiBGvJL1XrAfv7siY2',
    placeholder: '云中谁寄锦书来，雁字回时，月满西楼。&#10;Tips：如果希望收到我的评论回复，请至少留下你的邮箱哦:)',
    path:'https://qinyuanpei.github.io/posts/3411909634/', 
    avatar:'identicon',
    requiredFields: ['nick','mail']
});
</script>




    </article>
    
<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        赠人玫瑰，手有余香
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/assets/images/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/assets/images/wechat.png" data-alipay="/assets/images/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>


    <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/yoniu.min.js"></script>
<style type='text/css'>
	body.active-yp {
		overflow: hidden;
	}
	.yp-fc-btn{
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		align-items: center;
		justify-content: space-between;
		font-size: 13px;
	}
	.yp-fc-btn span{
		cursor: pointer;
		padding: 2px 10px;
		color: #4b4b4b;
		border: #4b4b4b 1px solid;
		border-radius:5px;
	}
	#yp-hide{
		position: fixed;
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		justify-content: center;
		flex-direction: column;
		left:0;
		top:0;
		right:0;
		bottom:0;
		background-color:rgba(0,0,0,.5);
		z-index: 99999;
		visibility: hidden;
	}
	#yoniu-poster{
		box-sizing: border-box;
		width: 350px;
		height: 467.2px;
		background-color: #fff;
		margin: 0 auto;
		padding: 0;
		line-height: 1.6;
		text-align:justify;
	}
	
	.yp-img {
		min-height: 240px;
		position: relative;
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		justify-content: flex-end;
		flex-direction: column;
		background-position: 50% 50%;
		background-size: cover;
		overflow:hidden;
	}
	.yp-img>div{
		padding: 10px 20px;
	}
	.yp-name{
		display: block;
		color: #fff;
		font-size: 20px;
		font-weight: 600;
		text-shadow: #4b4b4b 0.1em 0.1em 0.2em;
		margin-top: 10px;
	}
	.yp-sort{
		padding: 3px 10px;
		font-size: 12px;
		color: #fff;
		background: #2e2e2e;
	}
	.yp-des{
		color: #2e2e2e;
		font-size: 14px;
		margin: 20px;
		height: 67.2px;
	}
	.yp-qcode{
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		justify-content: space-between;
		align-items: center;
		margin: 10px;
		padding: 10px 20px;
		background: #f5f5f5;
		color: #818181;
		border-radius: 10px;
	}
	.yp-tips{
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		justify-content: space-between;
		align-items: center;
		color: #ccc;
		margin: 0 10px 10px;
		font-size: 10px;
		letter-spacing: 1.5px;
	}
	.yp-btns{
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		align-items: stretch;
		justify-content: center;
		width:350px;
		margin: 0 auto;
	}
	.yp-btns>span{
		display: flex;
		display: -webkit-flex;
		display: -ms-flexbox;
		align-items: center;
		justify-content: center;
		font-size: 14px;
		padding: 10px 15px;
		background:rgba(0,0,0,.2);
		color: #f5f5f5;
		cursor: pointer;
	}
	.yp-btns>span>a{
		color: #f5f5f5;
	}
	.yp-btns>span>a:hover{
		text-decoration:none;
	}
	#yp-close{
		font-size: 18px;
		font-weight: 600;
	}
</style>
<div id="yp-hide">
    <div id="yoniu-poster">
        <div class="yp-img" id="yp-img">
            <div>
                <span class="yp-sort">编程语言</span>
                <span class="yp-name">一道 HashSet 面试题引发的蝴蝶效应</span>
            </div>
        </div>
        <div class="yp-des">    
            
                没错，我又借着“面试题”的名头来搞事情了，今天要说的是 HashSet ，而这确实是一个实际面试中遇到的问题。当时的场景大概是这样的，面试官在了...
            
        </div>
        <div class="yp-qcode">
            <span>扫描二维码阅读原文</span>
            <img id="yp-qcode" width="64px" src="//api.qrserver.com/v1/create-qr-code/?data=https://qinyuanpei.github.io/posts/3411909634/">
        </div>
        <div class="yp-tips">
            <span>一个人的孤落时辰</span>
            <span><time class="post-time" title="2020-10-20 12:19:02" datetime="2020-10-20T12:19:02.000Z"  itemprop="datePublished">2020-10-20</time>
</span>
        </div>
    </div>
    <div class="yp-btns">
        <span id="yp-load-yp" onClick="load_yp()">生成海报</span>
        <span><a id="yp-download"></a></span>
        <span id="yp-close" onClick="close_yp()">×</span>
    </div>
</div>
<script type="text/javascript">
    function show_yp(){
        window.scrollTo(0, 0);
        document.body.setAttribute("class","active-yp");
        let cover = document.getElementsByTagName('img')[1];
        if (cover != null && typeof(cover) != 'undefined') {
            document.getElementById('yp-img').style.backgroundImage = `url(${cover.src})`;
        } else {
            document.getElementById('yp-img').style.backgroundColor = '#d7dbf0';
        }
        document.getElementById("yp-hide").style.visibility = "visible";
    }
    function close_yp(){
        var domClass = document.body.getAttribute("class");
        domClass = domClass.replace("active-yp","");
        document.body.setAttribute("class",domClass);
        document.getElementById("yp-hide").style.visibility = "hidden";
    }
    function load_yp(){
        document.getElementById('yp-load-yp').textContent = '海报生成中...';
        setTimeout(function() {
            h2c_();
        },2000);

    }
</script>

</div>

        <footer class="footer">
    <div class="top">
        
   <p>
      <span id="lc_counter_container_site_uv">
         <i class="icon icon-user"></i><span id="lc_counter_value_site_uv"></span>
      </span>
      <span id="lc_counter_container_site_pv">
         <i class="icon icon-eye"></i><span id="lc_counter_value_site_pv"></span>
      </span>
  </p>


        <p>
   <a id="jinrishici-sentence" href="https://www.jinrishici.com/" target="_blank" rel="noopener">加载中</a>
</p>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
<script>
   jinrishici.load(function(result) {
      document.querySelector('#subtitle').innerText = result.data.content;
      document.querySelector('#jinrishici-sentence').innerText = result.data.content;
  });
</script>
            <!--Todo: 考虑重构为插件 -->
            <p>
                
                    <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
                
                <span>
                    <a href="https://github.com/qinyuanpei" target="_blank" rel="license noopener" title="Github">
                        <i class="icon icon-lg icon-github"></i>
                    </a>
                </span>
                <span>
                    <a href="https://weibo.com/1278609231/profile" target="_blank" rel="license noopener" title="微博">
                        <i class="icon icon-lg icon-weibo"></i>
                    </a>
                </span>
                <span>
                    <a href="https://www.douban.com/people/60029335/" target="_blank" rel="license noopener" title="豆瓣">
                        <i class="icon icon-lg icon-douban"></i>
                    </a>
                </span>
                <span>
                    <a href="https://www.zhihu.com/people/qinyuanpei" target="_blank" rel="license noopener" title="知乎">
                        <i class="icon icon-lg icon-zhihu-square"></i>
                    </a>
                </span>
                <span>
                    <a href="https://blog.csdn.net/qinyuanpei" target="_blank" rel="license noopener" title="CSDN">
                        <i class="icon icon-lg">C</i>
                    </a>
                </span>
                <span>
                    <a href="https://music.163.com/#/user/home?id=47002864" target="_blank" rel="license noopener" title="网易音乐">
                        <i class="icon icon-lg icon-wangyiyunyinyue"></i>
                    </a>
                </span>
            </p>
        
    </div>
    <div class="bottom">
        <p><span>飞鸿踏雪 &copy; 2014 - 2021</span><br>
            
                
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & Theme by <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a><br>
                
                
                    <p>Hosted by <a href="https://pages.github.com" target="_blank" rel="noopener" style="font-weight: bold">Github Pages</a></p>
                
        </p>
    </div>
</footer>
    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span
        class="icon icon-lg icon-chevron-up"></span></a>

    

<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://qinyuanpei.github.io/posts/3411909634/&title=《一道 HashSet 面试题引发的蝴蝶效应》 — 一个人的孤落时辰&pic=https://qinyuanpei.github.ioassets/images/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qinyuanpei.github.io/posts/3411909634/&title=《一道 HashSet 面试题引发的蝴蝶效应》 — 一个人的孤落时辰&source=一个人的孤落时辰 | 纵有疾风起，人生不言弃 | 隐约雷鸣，阴霾天空，即使天无雨，我亦留此地。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qinyuanpei.github.io/posts/3411909634/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《一道 HashSet 面试题引发的蝴蝶效应》 — 一个人的孤落时辰&url=https://qinyuanpei.github.io/posts/3411909634/&via=https://qinyuanpei.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://qinyuanpei.github.io/posts/3411909634/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" onClick="show_yp()" data-title=" 生成海报">
          <i class="icon icon-file-image-o"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://qinyuanpei.github.io/posts/3411909634/" alt="微信分享二维码">
</div>



    <script src="//cdn.bootcss.com/node-waves/0.7.6/waves.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.2.1/echarts.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/echarts-wordcloud.min.js" async></script>
<script>
    var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/main.min.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/search.min.js" async></script>



<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/heart.min.js" async></script>







<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/leancloud-counter.min.js"></script>
<script>
        (function () {
            var appId = 'JbHqRp2eMrTgIwYpfERH0g79-gzGzoHsz';
            var appKey = 'VsiKvLuiBGvJL1XrAfv7siY2';
            new VisitorCounter().init({
                appId: appId,       //应用ID, 必输
                appKey: appKey,      //应用Key, 必输
                region: '华北',      //华东,华北,国际, 默认华东
                domain: '',      //自定义域名
                collectIP: true, //是否收集IP及位置信息, 默认开启
                collectUA: true  //是否收集UserAgent, 默认开启
            });
        })();
</script>



<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/vconsole.min.js"></script>
<script type="text/javascript">
    //当地址中存在debug=true时，实例化vConsole
    if (location.href.indexOf('debug=true') > -1) {
        var vConsole = new VConsole();
    }
</script>


    <script>
    //国内用户自动重定向Coding Pages镜像
    // var ipInfo = JSON.parse(localStorage.getItem('ipInfo'));
    // if (ipInfo.country_code == 'CN') {
    //     location.href = location.href.replace('qinyuanpei.github.io', 'blog.yuanpei.me');
    // }
    </script>


<script>
titleArray = [];
function scrollTitle() {
    if (titleArray.length == 0) return;
    titleArray.push(titleArray[0]);
	titleArray.shift();
	document.title = titleArray.join("");
}
setInterval(scrollTitle, 500);
(function() {
    var originTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            titleArray = originTitile.split('');
            clearTimeout(titleTime);
        } else {
            document.title = originTitile;
            titleArray = originTitile.split('');
            titleTime = setTimeout(function() {
                document.title = originTitile;
                titleArray = [];
            },2000);
        }
    });
})();
</script>


<script src="//cdn.jsdelivr.net/gh/qinyuanpei/qinyuanpei.github.io@master/assets/scripts/ribbon.min.js"></script>
</body>
</html>
