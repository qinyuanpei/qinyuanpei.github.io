name: Github Actions for Hexo

on:
  push:
    branches:    
      - blog

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Use Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 14.x
    - name: Use Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
        architecture: 'x64'
    - name: For Linux
      run: |
        sudo apt-get install python-dev libxml2-dev libxslt1-dev zlib1g-dev
    - name: Install Requirements
      run: |
        python -m pip install pip -U
        python -m pip config set global.index-url http://mirrors.aliyun.com/pypi/simple/
        python -m pip config set install.trusted-host mirrors.aliyun.com
        # python -m pip install setuptools==33.1.1 
        # python -m pip install --default-timeout=50000 -r requirements.txt 
    - name: Setup Hexo
      run: npm install hexo-cli -g
    - name: Install Packages
      run: npm install
    - name: Clean & Generate
      run: | 
       hexo clean
       git rev-parse HEAD > VERSION.txt
    - name: Deploy Github Pages
      run: |
       rm _config.yml
       mv config-salve.yml _config.yml
       hexo recommend
       hexo douban
       hexo generate
       # python readme.py https://qinyuanpei.github.io/
       cp README.md ./public/README.md
       cp VERSION.txt ./public/VERSION.txt
       git config user.name "qinyuanpei"
       git config user.email "qinyuanpei@163.com"
       cd ./public
       git init 
       git remote add origin -m master https://github.com/qinyuanpei/qinyuanpe.github.io
       git add .
       git commit -m "Update Blog By Github Actions"
       git push --force --quiet "https://${CI_TOKEN}@${GH_REF}" master:master
      
      env:
        CI: true
        GH_REF: github.com/qinyuanpei/qinyuanpei.github.io
        CI_TOKEN: ${{ secrets.CI_TOKEN }}
