name: Deploy

on:
  push:
    branches:    
      - blog

jobs:
  build_static_pages:
    name: Build Static Pages
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout 
      uses: actions/checkout@v1

    - name: Setup Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 14.x

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
        architecture: 'x64'

    - name: Setup Dependency
      run: |
       npm install hexo-cli@4.3.0 -g
       npm install
       sudo apt-get install python-dev libxml2-dev libxslt1-dev zlib1g-dev
       python -m pip install pip -U
       python -m pip config set global.index-url http://mirrors.aliyun.com/pypi/simple/
       python -m pip config set install.trusted-host mirrors.aliyun.com
        # python -m pip install setuptools==33.1.1 
        # python -m pip install --default-timeout=50000 -r requirements.txt 

    - name: Hexo Clean
      run: | 
       hexo clean
       git rev-parse HEAD > VERSION.txt

    - name: Generate Artifacts for qinyuanpei.github.io
      run: |
       sudo rm _config.yml
       sudo mv config-salve.yml _config.yml
       hexo generate
       sudo cp README.md ./public/README.md
       sudo cp VERSION.txt ./public/VERSION.txt
       sudo mkdir -p /home/runner/work/artifacts/qinyuanpei.github.io
       sudo cp -r /home/runner/work/qinyuanpei.github.io/qinyuanpei.github.io/public/* /home/runner/work/artifacts/qinyuanpei.github.io

    - name: Upload Artifacts for qinyuanpei.github.io
      uses: actions/upload-artifact@v1
      with:
        name: qinyuanpei.github.io
        path: /home/runner/work/artifacts/qinyuanpei.github.io

    - name: Generate Artifactsfor blog.yuanpei.me
      run: |
       sudo rm _config.yml
       sudo mv config-master.yml _config.yml
       hexo generate
       sudo cp README.md ./public/README.md
       sudo cp VERSION.txt ./public/VERSION.txt
       sudo mkdir -p /home/runner/work/artifacts/blog.yuanpei.me
       sudo cp -r /home/runner/work/qinyuanpei.github.io/qinyuanpei.github.io/public/* /home/runner/work/artifacts/blog.yuanpei.me 

    - name: Upload Artifacts for blog.yuanpei.me
      uses: actions/upload-artifact@v1
      with:
        name: blog.yuanpei.me
        path: /home/runner/work/artifacts/blog.yuanpei.me
  
  
  deploy_static_pages:
    name: Deploy Static Pages
    needs: build_static_pages
    runs-on: ubuntu-latest
    steps:
    - name: Configure Git
      run: | 
       mkdir -p ~/.ssh
       echo "$CI_SSH_KEY" > ~/.ssh/id_rsa
       chmod 700 ~/.ssh
       chmod 600 ~/.ssh/id_rsa
       ssh-keyscan github.com >> ~/.ssh/known_hosts
       git config --global user.name "qinyuanpei"
       git config --global user.email "qinyuanpei@163.com"
      env:
        CI_SSH_KEY: ${{ secrets.CI_SSH_KEY }}
        SSH_AUTH_SOCK: /tmp/ssh_agent.sock

    - name: Download Artifacts for qinyuanpei.github.io
      uses: actions/download-artifact@v1
      with:
        name: qinyuanpei.github.io

    - name: Deploy Artifacts for qinyuanpei.github.io
      run: |
       cd ./qinyuanpei.github.io
       git init
       git config user.name "qinyuanpei"
       git config user.email "qinyuanpei@163.com"
       git remote add -m master origin https://github.com/qinyuanpei/qinyuanpe.github.io 
       git add .
       git commit -m "Github Action Build v${GITHUB_RUN_NUMBER}"
       git push --force --quiet "https://${GITHUB_TOKEN}@${GITHUB_REPO}" master:master
      env:
        GITHUB_REPO: github.com/qinyuanpei/qinyuanpei.github.io.git
        GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}

    - name: Download Artifacts for blog.yuanpei.me
      uses: actions/download-artifact@v1
      with:
        name: blog.yuanpei.me

    - name: Deploy Artifacts for blog.yuanpei.me
      uses: JamesIves/github-pages-deploy-action@4.1.4
      with:
       branch: master
       folder: blog.yuanpei.me
       ssh-key: ${{ secrets.CI_SSH_KEY }}  
       repository-name: qinyuanpei/blog.yuanpei.me
       git-config-name: qinyuanpei
       git-config-email: qinyuanpei@163.com
       commit-message: "Update Blog by Github Action"


      

  
    
    